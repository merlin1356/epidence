<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤"/>
  <meta name="theme-color" content="#2c3e50"/>
  <link rel="manifest" href="#" id="manifest-placeholder"/>
  <title>ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
    body{font-family:'Apple SD Gothic Neo','Malgun Gothic',Arial,sans-serif;background:#f0f2f5;overflow-x:hidden;}
    input,select,button,textarea{font-family:inherit;}
    button{cursor:pointer;}
    ::-webkit-scrollbar{width:4px;}
    ::-webkit-scrollbar-thumb{background:#bdc3c7;border-radius:2px;}
    #mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#2c3e50;z-index:500;padding:6px 0 max(6px,env(safe-area-inset-bottom));border-top:1px solid #34495e;}
    .mob-btn{flex:1;display:flex;flex-direction:column;align-items:center;background:none;border:none;color:#95a5a6;padding:6px 2px;font-size:10px;gap:3px;transition:color 0.2s;}
    .mob-btn span:first-child{font-size:20px;line-height:1;}
    .mob-btn.active{color:#3498db;}
    @media(max-width:768px){
      #sidebar{display:none!important;}
      #main{margin-left:0!important;padding:14px!important;padding-bottom:90px!important;}
      #mob-nav{display:flex!important;}
      .stat-grid{grid-template-columns:repeat(2,1fr)!important;}
      .modal-inner{width:100%!important;max-width:100%!important;border-radius:20px 20px 0 0!important;position:fixed!important;bottom:0!important;margin:0!important;max-height:94vh!important;}
      .modal-wrap{align-items:flex-end!important;padding:0!important;}
      h2{font-size:20px!important;}
    }
    @media(min-width:769px){#mob-nav{display:none!important;}}
    .btn{border:none;border-radius:8px;cursor:pointer;font-weight:bold;transition:opacity 0.2s;}
    .btn:hover{opacity:0.85;}
    .btn:active{opacity:0.7;}
    .card{background:white;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,0.08);}
    .login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#2c3e50,#3498db);padding:20px;}
    .login-box{background:white;border-radius:24px;padding:40px;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
    .pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:20px 0;}
    .pin-btn{padding:18px;font-size:22px;font-weight:bold;background:#f8f9fa;border:2px solid #ecf0f1;border-radius:12px;cursor:pointer;transition:all 0.15s;color:#2c3e50;}
    .pin-btn:active{background:#3498db;color:white;transform:scale(0.95);}
    /* ìˆ˜ë‚© íƒ­ ìŠ¤íƒ€ì¼ */
    .pay-tab{padding:8px 18px;border:2px solid #ddd;border-radius:20px;background:white;font-size:14px;font-weight:bold;color:#7f8c8d;cursor:pointer;transition:all 0.2s;}
    .pay-tab.active{background:#27ae60;border-color:#27ae60;color:white;}
    .pay-btn-unpaid{background:#ecf0f1;color:#7f8c8d;border:2px dashed #bdc3c7;border-radius:8px;padding:6px 12px;font-size:13px;font-weight:bold;width:100%;cursor:pointer;transition:all 0.2s;}
    .pay-btn-unpaid:hover{background:#d5f5e3;border-color:#27ae60;color:#27ae60;}
    .pay-btn-paid{background:#d5f5e3;color:#27ae60;border:2px solid #27ae60;border-radius:8px;padding:6px 12px;font-size:13px;font-weight:bold;width:100%;cursor:pointer;}
    .pay-btn-cancel{background:#fdeaea;color:#e74c3c;border:2px solid #e74c3c;border-radius:8px;padding:4px 8px;font-size:11px;cursor:pointer;margin-top:3px;width:100%;}
    .month-row{display:grid;grid-template-columns:60px 1fr 1fr 1fr;gap:10px;align-items:start;padding:10px 0;border-bottom:1px solid #f0f0f0;}
    .month-row:last-child{border-bottom:none;}
  </style>
</head>
<body>
<div id="root"></div>
<script>
  const manifest={name:"ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤ ì„ëŒ€ê´€ë¦¬",short_name:"ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤",start_url:window.location.href,display:"standalone",background_color:"#2c3e50",theme_color:"#2c3e50",icons:[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232c3e50'/><text y='.9em' font-size='70' x='15'>ğŸ¢</text></svg>",sizes:"512x512",type:"image/svg+xml"}]};
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  document.getElementById('manifest-placeholder').href=URL.createObjectURL(blob);
  if('serviceWorker' in navigator){const sw=`const C='v1';self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(['/']))));self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))));`;const swb=new Blob([sw],{type:'text/javascript'});navigator.serviceWorker.register(URL.createObjectURL(swb)).catch(()=>{});}
</script>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;
const sb = supabase.createClient(
  'https://fkvktmkcoyfvtsluzmeo.supabase.co',
  'sb_publishable_HBGYuYTBxwoeSBNG204NCw_gNd3fIfv'
);
const fNum = n => Math.round(n||0).toLocaleString('ko-KR');
const fMan = n => Math.round((n||0)/10000).toLocaleString('ko-KR')+'ë§Œì›';
const fUk  = n => ((n||0)/100000000).toFixed(2)+'ì–µì›';
const thisMonth = () => new Date().toISOString().slice(0,7);

// â”€â”€ ë¡œê·¸ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginScreen({onLogin}) {
  const [pin,setPin]=useState('');
  const [error,setError]=useState('');
  const [loading,setLoading]=useState(false);
  const handleNum = n => {
    if(pin.length>=6||loading) return;
    const next=pin+n; setPin(next); setError('');
    if(next.length>=4) checkPin(next);
  };
  const checkPin = async code => {
    setLoading(true);
    const {data}=await sb.from('admins').select('*').eq('passcode',code).eq('active',true);
    if(data&&data.length>0){ onLogin(data[0]); }
    else { setTimeout(()=>{setError('âŒ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');setPin('');setLoading(false);},400); }
  };
  return (
    <div className="login-wrap">
      <div className="login-box">
        <div style={{fontSize:'52px',marginBottom:'12px'}}>ğŸ¢</div>
        <h1 style={{fontSize:'24px',color:'#2c3e50',marginBottom:'4px',fontWeight:'bold'}}>ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤</h1>
        <p style={{color:'#7f8c8d',fontSize:'14px',marginBottom:'24px'}}>ì„ëŒ€ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        <div style={{background:'#f8f9fa',borderRadius:'12px',padding:'14px 20px',marginBottom:'8px',minHeight:'56px',display:'flex',alignItems:'center',justifyContent:'center'}}>
          {loading?<span style={{color:'#27ae60',fontSize:'18px'}}>âœ” í™•ì¸ì¤‘...</span>:
            <span style={{fontSize:'32px',letterSpacing:'10px',color:'#2c3e50'}}>
              {pin?pin.split('').map(()=>'â—').join(' '):<span style={{fontSize:'14px',color:'#bdc3c7',letterSpacing:'1px'}}>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</span>}
            </span>}
        </div>
        {error&&<div style={{color:'#e74c3c',fontSize:'14px',marginBottom:'8px',fontWeight:'bold'}}>{error}</div>}
        <div className="pin-grid">
          {[1,2,3,4,5,6,7,8,9].map(n=><button key={n} className="pin-btn" onClick={()=>handleNum(String(n))}>{n}</button>)}
          <button className="pin-btn" onClick={()=>{setPin('');setError('');}} style={{color:'#e74c3c'}}>C</button>
          <button className="pin-btn" onClick={()=>handleNum('0')}>0</button>
          <button className="pin-btn" onClick={()=>setPin(p=>p.slice(0,-1))} style={{color:'#e74c3c'}}>âŒ«</button>
        </div>
        <p style={{fontSize:'12px',color:'#bdc3c7',marginTop:'8px'}}>ê´€ë¦¬ì ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
      </div>
    </div>
  );
}

// â”€â”€ ìˆ˜ë‚© ê´€ë¦¬ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PaymentModal({tenant, payments, onClose, onRefresh}) {
  const [activeType, setActiveType] = useState('rent'); // rent, fee, other
  const [year, setYear] = useState(new Date().getFullYear());
  const [otherModal, setOtherModal] = useState(null); // {yearMonth}
  const [otherForm, setOtherForm] = useState({amount:'', note:''});
  const [saving, setSaving] = useState(false);

  const months = Array.from({length:12},(_,i)=>String(i+1).padStart(2,'0'));

  // í•´ë‹¹ í˜¸ìˆ˜ì˜ ìˆ˜ë‚© ë°ì´í„° í•„í„°
  const tenantPayments = payments.filter(p => p.tenant_id === tenant.id);

  const getPayment = (ym, type) => tenantPayments.filter(p => p.year_month===ym && p.type===type);

  const isPaid = (ym, type) => {
    const pays = getPayment(ym, type);
    if(type==='rent') return pays.some(p=>p.amount>0);
    if(type==='fee') return pays.some(p=>p.amount>0);
    return pays.length>0;
  };

  const handlePay = async (ym, type) => {
    if(saving) return;
    if(isPaid(ym,type)) return;
    setSaving(true);
    const amount = type==='rent' ? tenant.monthly_rent : tenant.maintenance_fee;
    await sb.from('payments').insert([{tenant_id:tenant.id, year_month:ym, type, amount, note:'ìˆ˜ë‚©ì™„ë£Œ'}]);
    await onRefresh();
    setSaving(false);
  };

  const handleCancel = async (ym, type) => {
    if(!window.confirm('ìˆ˜ë‚©ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const pays = getPayment(ym, type);
    for(const p of pays) await sb.from('payments').delete().eq('id',p.id);
    await onRefresh();
  };

  const handleOtherSave = async () => {
    if(!otherForm.amount || parseInt(otherForm.amount)<=0) return;
    setSaving(true);
    await sb.from('payments').insert([{tenant_id:tenant.id, year_month:otherModal, type:'other', amount:parseInt(otherForm.amount), note:otherForm.note||'ê¸°íƒ€ìˆ˜ë‚©'}]);
    await onRefresh();
    setOtherModal(null);
    setOtherForm({amount:'',note:''});
    setSaving(false);
  };

  const handleOtherDelete = async (id) => {
    if(!window.confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    await sb.from('payments').delete().eq('id',id);
    await onRefresh();
  };

  // ì—°ë„ë³„ í•©ê³„
  const yearPaid = {rent:0, fee:0, other:0};
  months.forEach(m => {
    const ym = `${year}-${m}`;
    getPayment(ym,'rent').forEach(p=>yearPaid.rent+=p.amount);
    getPayment(ym,'fee').forEach(p=>yearPaid.fee+=p.amount);
    getPayment(ym,'other').forEach(p=>yearPaid.other+=p.amount);
  });
  const totalPaid = yearPaid.rent+yearPaid.fee+yearPaid.other;
  const expected = {rent: tenant.monthly_rent*12, fee: tenant.maintenance_fee*12};

  const typeLabel = {rent:'ì›”ì„¸', fee:'ê´€ë¦¬ë¹„', other:'ê¸°íƒ€'};
  const typeColor = {rent:'#3498db', fee:'#e67e22', other:'#9b59b6'};
  const typeExpected = {rent:tenant.monthly_rent, fee:tenant.maintenance_fee, other:0};

  return (
    <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.65)',zIndex:2000,display:'flex',alignItems:'center',justifyContent:'center',padding:'16px'}}
      onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div style={{background:'white',borderRadius:'20px',width:'100%',maxWidth:'680px',maxHeight:'92vh',overflowY:'auto',position:'relative'}} onClick={e=>e.stopPropagation()}>

        {/* í—¤ë” */}
        <div style={{background:'#2c3e50',color:'white',padding:'20px 24px',borderRadius:'20px 20px 0 0',position:'sticky',top:0,zIndex:10}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div>
              <div style={{fontSize:'20px',fontWeight:'bold'}}>ğŸ  {tenant.room} {tenant.name}</div>
              <div style={{fontSize:'13px',opacity:0.7,marginTop:'3px'}}>ì›”ì„¸ {fNum(tenant.monthly_rent)}ì› / ê´€ë¦¬ë¹„ {fNum(tenant.maintenance_fee)}ì›</div>
            </div>
            <button onClick={onClose} style={{background:'#e74c3c',color:'white',border:'none',borderRadius:'50%',width:'34px',height:'34px',fontSize:'20px',cursor:'pointer',fontWeight:'bold',lineHeight:1}}>Ã—</button>
          </div>

          {/* ì—°ë„ ì„ íƒ */}
          <div style={{display:'flex',alignItems:'center',gap:'12px',marginTop:'14px'}}>
            <button onClick={()=>setYear(y=>y-1)} style={{background:'rgba(255,255,255,0.2)',color:'white',border:'none',borderRadius:'8px',padding:'6px 12px',cursor:'pointer',fontSize:'16px'}}>â—€</button>
            <span style={{fontSize:'18px',fontWeight:'bold'}}>{year}ë…„</span>
            <button onClick={()=>setYear(y=>y+1)} style={{background:'rgba(255,255,255,0.2)',color:'white',border:'none',borderRadius:'8px',padding:'6px 12px',cursor:'pointer',fontSize:'16px'}}>â–¶</button>
          </div>

          {/* íƒ­ */}
          <div style={{display:'flex',gap:'8px',marginTop:'14px'}}>
            {['rent','fee','other'].map(type=>(
              <button key={type} className={`pay-tab${activeType===type?' active':''}`}
                onClick={()=>setActiveType(type)}
                style={{borderColor: activeType===type ? typeColor[type] : '#ddd', background: activeType===type ? typeColor[type] : 'rgba(255,255,255,0.9)', color: activeType===type ? 'white' : '#555'}}>
                {typeLabel[type]}
              </button>
            ))}
          </div>
        </div>

        <div style={{padding:'20px 24px'}}>
          {/* ì—° ìˆ˜ë‚© ìš”ì•½ */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'10px',marginBottom:'20px'}}>
            {[
              {label:'ì›”ì„¸ ìˆ˜ë‚©', val:yearPaid.rent, exp:expected.rent, color:'#3498db'},
              {label:'ê´€ë¦¬ë¹„ ìˆ˜ë‚©', val:yearPaid.fee, exp:expected.fee, color:'#e67e22'},
              {label:'ê¸°íƒ€ ìˆ˜ë‚©', val:yearPaid.other, exp:null, color:'#9b59b6'},
            ].map(({label,val,exp,color})=>(
              <div key={label} style={{background:'#f8f9fa',borderRadius:'12px',padding:'12px',borderLeft:`4px solid ${color}`}}>
                <div style={{fontSize:'11px',color:'#7f8c8d',marginBottom:'4px'}}>{label}</div>
                <div style={{fontSize:'16px',fontWeight:'bold',color}}>{fNum(val)}ì›</div>
                {exp!=null && <div style={{fontSize:'11px',color:val>=exp?'#27ae60':'#e74c3c',marginTop:'2px'}}>/ {fNum(exp)}ì› ({exp>0?Math.round(val/exp*100):0}%)</div>}
              </div>
            ))}
          </div>

          {/* ì›”ì„¸ íƒ­ */}
          {activeType==='rent' && (
            <div>
              <div style={{display:'grid',gridTemplateColumns:'60px 1fr 100px',gap:'8px',padding:'8px 0',borderBottom:'2px solid #ecf0f1',marginBottom:'8px'}}>
                <div style={{fontSize:'12px',color:'#7f8c8d',fontWeight:'bold'}}>ì›”</div>
                <div style={{fontSize:'12px',color:'#7f8c8d',fontWeight:'bold'}}>ê¸ˆì•¡</div>
                <div style={{fontSize:'12px',color:'#7f8c8d',fontWeight:'bold'}}>ìˆ˜ë‚©ìƒíƒœ</div>
              </div>
              {months.map(m=>{
                const ym=`${year}-${m}`;
                const paid=isPaid(ym,'rent');
                const pays=getPayment(ym,'rent');
                return (
                  <div key={m} style={{display:'grid',gridTemplateColumns:'60px 1fr 100px',gap:'8px',alignItems:'center',padding:'10px 0',borderBottom:'1px solid #f5f5f5'}}>
                    <div style={{fontSize:'15px',fontWeight:'bold',color:'#2c3e50'}}>{parseInt(m)}ì›”</div>
                    <div style={{fontSize:'14px',color:'#2c3e50'}}>{fNum(tenant.monthly_rent)}ì›</div>
                    <div>
                      {paid ? (
                        <>
                          <div className="pay-btn-paid">âœ… ìˆ˜ë‚©ì™„ë£Œ</div>
                          <button className="pay-btn-cancel" onClick={()=>handleCancel(ym,'rent')}>ì·¨ì†Œ</button>
                        </>
                      ) : (
                        <button className="pay-btn-unpaid" onClick={()=>handlePay(ym,'rent')} disabled={saving}>
                          ğŸ’° ìˆ˜ë‚©
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* ê´€ë¦¬ë¹„ íƒ­ */}
          {activeType==='fee' && (
            <div>
              <div style={{display:'grid',gridTemplateColumns:'60px 1fr 100px',gap:'8px',padding:'8px 0',borderBottom:'2px solid #ecf0f1',marginBottom:'8px'}}>
                <div style={{fontSize:'12px',color:'#7f8c8d',fontWeight:'bold'}}>ì›”</div>
                <div style={{fontSize:'12px',color:'#7f8c8d',fontWeight:'bold'}}>ê¸ˆì•¡</div>
                <div style={{fontSize:'12px',color:'#7f8c8d',fontWeight:'bold'}}>ìˆ˜ë‚©ìƒíƒœ</div>
              </div>
              {months.map(m=>{
                const ym=`${year}-${m}`;
                const paid=isPaid(ym,'fee');
                return (
                  <div key={m} style={{display:'grid',gridTemplateColumns:'60px 1fr 100px',gap:'8px',alignItems:'center',padding:'10px 0',borderBottom:'1px solid #f5f5f5'}}>
                    <div style={{fontSize:'15px',fontWeight:'bold',color:'#2c3e50'}}>{parseInt(m)}ì›”</div>
                    <div style={{fontSize:'14px',color:'#2c3e50'}}>{fNum(tenant.maintenance_fee)}ì›</div>
                    <div>
                      {paid ? (
                        <>
                          <div className="pay-btn-paid">âœ… ìˆ˜ë‚©ì™„ë£Œ</div>
                          <button className="pay-btn-cancel" onClick={()=>handleCancel(ym,'fee')}>ì·¨ì†Œ</button>
                        </>
                      ) : (
                        <button className="pay-btn-unpaid" onClick={()=>handlePay(ym,'fee')} disabled={saving}>
                          ğŸ’° ìˆ˜ë‚©
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* ê¸°íƒ€ íƒ­ */}
          {activeType==='other' && (
            <div>
              {months.map(m=>{
                const ym=`${year}-${m}`;
                const others=getPayment(ym,'other');
                return (
                  <div key={m} style={{padding:'12px 0',borderBottom:'1px solid #f5f5f5'}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom: others.length>0?'8px':'0'}}>
                      <span style={{fontSize:'15px',fontWeight:'bold',color:'#2c3e50'}}>{parseInt(m)}ì›”</span>
                      <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                        {others.length>0 && <span style={{fontSize:'13px',color:'#9b59b6',fontWeight:'bold'}}>í•©ê³„: {fNum(others.reduce((s,p)=>s+p.amount,0))}ì›</span>}
                        <button onClick={()=>{setOtherModal(ym);setOtherForm({amount:'',note:''});}}
                          style={{background:'#9b59b6',color:'white',border:'none',borderRadius:'8px',padding:'6px 12px',cursor:'pointer',fontSize:'13px',fontWeight:'bold'}}>
                          + ì¶”ê°€
                        </button>
                      </div>
                    </div>
                    {others.map(p=>(
                      <div key={p.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',background:'#f5f0ff',borderRadius:'8px',padding:'8px 12px',marginBottom:'6px'}}>
                        <div>
                          <div style={{fontSize:'14px',fontWeight:'bold',color:'#9b59b6'}}>{fNum(p.amount)}ì›</div>
                          <div style={{fontSize:'12px',color:'#7f8c8d'}}>{p.note}</div>
                        </div>
                        <button onClick={()=>handleOtherDelete(p.id)} style={{background:'#e74c3c',color:'white',border:'none',borderRadius:'6px',padding:'4px 8px',cursor:'pointer',fontSize:'12px'}}>ì‚­ì œ</button>
                      </div>
                    ))}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      {/* ê¸°íƒ€ ì…ë ¥ ì„œë¸Œëª¨ë‹¬ */}
      {otherModal && (
        <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',zIndex:3000,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px'}}
          onClick={e=>{if(e.target===e.currentTarget)setOtherModal(null);}}>
          <div style={{background:'white',borderRadius:'16px',padding:'24px',width:'100%',maxWidth:'360px'}}>
            <h3 style={{fontSize:'18px',color:'#2c3e50',marginBottom:'16px'}}>ğŸ’œ ê¸°íƒ€ ìˆ˜ë‚© - {otherModal}</h3>
            <label style={{display:'block',fontSize:'13px',fontWeight:'bold',color:'#2c3e50',marginBottom:'6px'}}>ê¸ˆì•¡ (ì›)</label>
            <input type="number" value={otherForm.amount} onChange={e=>setOtherForm({...otherForm,amount:e.target.value})} placeholder="ì˜ˆ: 50000" style={{width:'100%',padding:'12px',border:'2px solid #9b59b6',borderRadius:'8px',fontSize:'16px',marginBottom:'12px',boxSizing:'border-box'}}/>
            <label style={{display:'block',fontSize:'13px',fontWeight:'bold',color:'#2c3e50',marginBottom:'6px'}}>ë©”ëª¨</label>
            <input value={otherForm.note} onChange={e=>setOtherForm({...otherForm,note:e.target.value})} placeholder="ì˜ˆ: ì£¼ì°¨ë¹„, ì—°ì¥ìˆ˜ìˆ˜ë£Œ..." style={{width:'100%',padding:'12px',border:'2px solid #ecf0f1',borderRadius:'8px',fontSize:'16px',marginBottom:'16px',boxSizing:'border-box'}}/>
            <div style={{display:'flex',gap:'10px'}}>
              <button onClick={()=>setOtherModal(null)} style={{flex:1,padding:'13px',background:'#95a5a6',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'15px',fontWeight:'bold'}}>ì·¨ì†Œ</button>
              <button onClick={handleOtherSave} disabled={saving} style={{flex:1,padding:'13px',background:'#9b59b6',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'15px',fontWeight:'bold'}}>ì €ì¥</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€ ë©”ì¸ ì•± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [admin,setAdmin]=useState(null);
  const [activeTab,setActiveTab]=useState('dashboard');
  const [tenants,setTenants]=useState([]);
  const [expenses,setExpenses]=useState([]);
  const [loans,setLoans]=useState([]);
  const [admins,setAdmins]=useState([]);
  const [expenseCategories,setExpenseCategories]=useState([]);
  const [payments,setPayments]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showModal,setShowModal]=useState(false);
  const [modalType,setModalType]=useState('');
  const [editItem,setEditItem]=useState(null);
  const [formData,setFormData]=useState({});
  const [selectedMonth,setSelectedMonth]=useState(thisMonth());
  const [tenantSort,setTenantSort]=useState('room');
  const [payTenant,setPayTenant]=useState(null); // ìˆ˜ë‚©ê´€ë¦¬ ì—´ë¦° ì„ì°¨ì¸

  useEffect(()=>{if(admin)loadData();},[admin]);

  const loadData = async () => {
    setLoading(true);
    try {
      const [t,e,l,ec,a,p]=await Promise.all([
        sb.from('tenants').select('*').order('room'),
        sb.from('expenses').select('*').order('date',{ascending:false}),
        sb.from('loans').select('*').order('lender_name'),
        sb.from('expense_categories').select('*').order('name'),
        sb.from('admins').select('id,name,role,active').order('name'),
        sb.from('payments').select('*').order('paid_at',{ascending:false})
      ]);
      setTenants(t.data||[]);
      setExpenses(e.data||[]);
      setLoans(l.data||[]);
      setExpenseCategories(ec.data||[]);
      setAdmins(a.data||[]);
      setPayments(p.data||[]);
    } catch(err){console.error(err);}
    finally{setLoading(false);}
  };

  const loadPayments = async () => {
    const {data}=await sb.from('payments').select('*').order('paid_at',{ascending:false});
    setPayments(data||[]);
  };

  const openModal=(type,item=null)=>{
    setModalType(type); setEditItem(item);
    const defaults={
      tenant:{name:'',room:'',contact:'',deposit:0,monthly_rent:0,maintenance_fee:0,payment_day:5,move_in_date:'',contract_end:'',status:'active'},
      expense:{date:new Date().toISOString().split('T')[0],category_name:'',amount:0,description:''},
      loan:{lender_name:'',initial_amount:0,remaining_amount:0,final_rate:0,start_date:'',loan_type:'bank',status:'active',note:''},
      admin:{name:'',passcode:'',role:'admin',active:true}
    };
    setFormData(item?{...item}:defaults[type]);
    setShowModal(true);
  };

  const saveData=async(e)=>{
    e.preventDefault();
    const tables={tenant:'tenants',expense:'expenses',loan:'loans',admin:'admins'};
    try{
      if(editItem){await sb.from(tables[modalType]).update(formData).eq('id',editItem.id);}
      else{await sb.from(tables[modalType]).insert([formData]);}
      await loadData(); setShowModal(false); setFormData({}); setEditItem(null);
    }catch(err){alert('ì €ì¥ ì‹¤íŒ¨: '+err.message);}
  };

  const deleteItem=async(table,id)=>{
    if(!window.confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
    await sb.from(table).delete().eq('id',id);
    await loadData();
  };

  if(!admin) return <LoginScreen onLogin={setAdmin}/>;

  // í†µê³„
  const curExp=expenses.filter(e=>e.date?.startsWith(selectedMonth));
  const totalExp=curExp.reduce((s,e)=>s+(e.amount||0),0);
  // ëŒ€ì‹œë³´ë“œ ìˆ˜ìµì€ ì‹¤ì œ ìˆ˜ë‚©ëœ ê¸ˆì•¡ ê¸°ì¤€
  const curPayments=payments.filter(p=>p.year_month===selectedMonth);
  const totalRev=curPayments.reduce((s,p)=>s+(p.amount||0),0);
  const totalLoan=loans.reduce((s,l)=>s+(l.remaining_amount||0),0);
  const totalMInt=loans.reduce((s,l)=>s+((l.remaining_amount*l.final_rate)/12),0);
  const profit=totalRev-totalExp;
  const byCat=curExp.reduce((acc,e)=>{acc[e.category_name||'ê¸°íƒ€']=(acc[e.category_name||'ê¸°íƒ€']||0)+e.amount;return acc;},{});
  const totalDep=tenants.reduce((s,t)=>s+(t.deposit||0),0);
  const totalRent=tenants.reduce((s,t)=>s+(t.monthly_rent||0),0);
  const totalFee=tenants.reduce((s,t)=>s+(t.maintenance_fee||0),0);
  const sortedTenants=[...tenants].sort((a,b)=>tenantSort==='room'?(a.room||'').localeCompare(b.room||'','ko'):(a.payment_day||0)-(b.payment_day||0));

  // ì´ë²ˆë‹¬ ë¯¸ë‚© í˜„í™©
  const curMonthStr=selectedMonth;
  const unpaidRent=tenants.filter(t=>!payments.some(p=>p.tenant_id===t.id&&p.year_month===curMonthStr&&p.type==='rent'));
  const unpaidFee=tenants.filter(t=>!payments.some(p=>p.tenant_id===t.id&&p.year_month===curMonthStr&&p.type==='fee'));

  const tabs=[
    {id:'dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},
    {id:'tenants',icon:'ğŸ‘¥',label:'ì„ì°¨ì¸'},
    {id:'expenses',icon:'ğŸ’¸',label:'ì§€ì¶œ'},
    {id:'loans',icon:'ğŸ¦',label:'ëŒ€ì¶œ'},
    {id:'admins',icon:'âš™ï¸',label:'ê´€ë¦¬ì'}
  ];
  const s={input:{width:'100%',padding:'12px',border:'2px solid #ecf0f1',borderRadius:'8px',fontSize:'15px',marginBottom:'12px'},label:{display:'block',marginBottom:'6px',fontSize:'13px',fontWeight:'bold',color:'#2c3e50'}};

  return (
    <div style={{display:'flex',minHeight:'100vh'}}>
      {/* ì‚¬ì´ë“œë°” */}
      <div id="sidebar" style={{width:'240px',background:'#2c3e50',color:'white',padding:'20px',position:'fixed',height:'100vh',overflowY:'auto',zIndex:100}}>
        <div style={{marginBottom:'8px'}}>
          <div style={{fontSize:'20px',fontWeight:'bold'}}>ğŸ¢ ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤</div>
          <div style={{fontSize:'12px',color:'#7f8c8d',marginTop:'4px'}}>ğŸ‘¤ {admin.name}</div>
        </div>
        <hr style={{borderColor:'#34495e',margin:'14px 0'}}/>
        <nav>
          {tabs.map(({id,icon,label})=>(
            <button key={id} onClick={()=>setActiveTab(id)} style={{display:'flex',alignItems:'center',gap:'10px',width:'100%',padding:'12px 14px',marginBottom:'6px',background:activeTab===id?'#3498db':'transparent',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'15px',textAlign:'left',transition:'background 0.2s'}}>
              <span>{icon}</span><span>{label}</span>
            </button>
          ))}
        </nav>
        <div style={{position:'absolute',bottom:'20px',left:'20px',right:'20px'}}>
          <div style={{padding:'10px',background:'#27ae60',borderRadius:'8px',fontSize:'12px',textAlign:'center',marginBottom:'8px'}}>â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°</div>
          <button onClick={()=>setAdmin(null)} style={{width:'100%',padding:'10px',background:'#e74c3c',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'13px',fontWeight:'bold'}}>ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      {/* ë©”ì¸ */}
      <div id="main" style={{flex:1,marginLeft:'240px',padding:'28px',maxWidth:'100%'}}>
        {loading&&<div style={{textAlign:'center',padding:'60px',color:'#7f8c8d',fontSize:'18px'}}>ë¡œë”©ì¤‘...</div>}

        {/* â”€â”€ ëŒ€ì‹œë³´ë“œ â”€â”€ */}
        {!loading&&activeTab==='dashboard'&&(
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'18px',flexWrap:'wrap',gap:'10px'}}>
              <h2 style={{fontSize:'26px',color:'#2c3e50',fontWeight:'bold'}}>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
              <input type="month" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)} style={{padding:'8px 14px',fontSize:'15px',borderRadius:'8px',border:'2px solid #3498db'}}/>
            </div>
            <div className="stat-grid" style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:'12px',marginBottom:'20px'}}>
              {[
                {label:'ì‹¤ ìˆ˜ë‚©ìˆ˜ìµ',val:fMan(totalRev),color:'#27ae60'},
                {label:'ì›” ì§€ì¶œ',val:fMan(totalExp),color:'#e74c3c'},
                {label:'ìˆœìµ',val:fMan(profit),color:profit>=0?'#3498db':'#e74c3c'},
                {label:'ëŒ€ì¶œì”ì•¡',val:fUk(totalLoan),color:'#c0392b'},
                {label:'ì›” ì´ì',val:fMan(totalMInt),color:'#e67e22'}
              ].map(({label,val,color})=>(
                <div key={label} className="card" style={{padding:'16px',borderTop:`4px solid ${color}`}}>
                  <div style={{fontSize:'11px',color:'#7f8c8d',marginBottom:'6px'}}>{label}</div>
                  <div style={{fontSize:'18px',fontWeight:'bold',color}}>{val}</div>
                </div>
              ))}
            </div>
            {/* ë¯¸ë‚© í˜„í™© */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))',gap:'14px',marginBottom:'18px'}}>
              <div className="card" style={{padding:'18px',borderLeft:'5px solid #e74c3c'}}>
                <div style={{fontSize:'14px',fontWeight:'bold',color:'#e74c3c',marginBottom:'10px'}}>âš ï¸ ì´ë²ˆë‹¬ ì›”ì„¸ ë¯¸ë‚© ({unpaidRent.length}ê±´)</div>
                {unpaidRent.length===0?<p style={{color:'#27ae60',fontSize:'14px'}}>âœ… ì „ì› ìˆ˜ë‚©ì™„ë£Œ!</p>:
                  unpaidRent.map(t=>(
                    <div key={t.id} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid #f5f5f5',fontSize:'14px'}}>
                      <span style={{fontWeight:'bold',color:'#3498db'}}>{t.room} {t.name}</span>
                      <span style={{color:'#e74c3c'}}>{fNum(t.monthly_rent)}ì›</span>
                    </div>
                  ))
                }
              </div>
              <div className="card" style={{padding:'18px',borderLeft:'5px solid #e67e22'}}>
                <div style={{fontSize:'14px',fontWeight:'bold',color:'#e67e22',marginBottom:'10px'}}>âš ï¸ ì´ë²ˆë‹¬ ê´€ë¦¬ë¹„ ë¯¸ë‚© ({unpaidFee.length}ê±´)</div>
                {unpaidFee.length===0?<p style={{color:'#27ae60',fontSize:'14px'}}>âœ… ì „ì› ìˆ˜ë‚©ì™„ë£Œ!</p>:
                  unpaidFee.map(t=>(
                    <div key={t.id} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid #f5f5f5',fontSize:'14px'}}>
                      <span style={{fontWeight:'bold',color:'#3498db'}}>{t.room} {t.name}</span>
                      <span style={{color:'#e67e22'}}>{fNum(t.maintenance_fee)}ì›</span>
                    </div>
                  ))
                }
              </div>
            </div>
            <div className="card" style={{padding:'18px'}}>
              <h3 style={{fontSize:'15px',marginBottom:'14px',color:'#2c3e50'}}>ğŸ’¸ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ({selectedMonth})</h3>
              {Object.keys(byCat).length===0?<p style={{color:'#95a5a6',fontSize:'14px'}}>ì´ë²ˆ ë‹¬ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</p>:
                Object.entries(byCat).sort((a,b)=>b[1]-a[1]).map(([cat,amt])=>(
                  <div key={cat} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid #f5f5f5'}}>
                    <span style={{color:'#2c3e50',fontSize:'14px'}}>{cat}</span>
                    <strong style={{color:'#e74c3c',fontSize:'14px'}}>{fMan(amt)}</strong>
                  </div>
                ))
              }
            </div>
          </div>
        )}

        {/* â”€â”€ ì„ì°¨ì¸ â”€â”€ */}
        {!loading&&activeTab==='tenants'&&(
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'18px',flexWrap:'wrap',gap:'10px'}}>
              <h2 style={{fontSize:'26px',color:'#2c3e50',fontWeight:'bold'}}>ğŸ‘¥ ì„ì°¨ì¸ ê´€ë¦¬</h2>
              <div style={{display:'flex',gap:'8px',alignItems:'center',flexWrap:'wrap'}}>
                <input type="month" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)} style={{padding:'8px 12px',fontSize:'14px',borderRadius:'8px',border:'2px solid #27ae60'}}/>
                <button className="btn" onClick={()=>openModal('tenant')} style={{padding:'11px 20px',background:'#27ae60',color:'white',fontSize:'14px'}}>+ ìƒˆ ì„ì°¨ì¸</button>
              </div>
            </div>
            {/* í•©ê³„ */}
            <div className="stat-grid" style={{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:'10px',marginBottom:'16px'}}>
              {[
                {label:'ì´ ì„ì°¨ì¸',val:`${tenants.length}ëª…`,color:'#3498db'},
                {label:'ë³´ì¦ê¸ˆ í•©ê³„',val:`${(totalDep/100000000).toFixed(1)}ì–µ`,color:'#9b59b6'},
                {label:'ì›”ì„¸ í•©ê³„',val:fMan(totalRent),color:'#27ae60'},
                {label:'ê´€ë¦¬ë¹„ í•©ê³„',val:fMan(totalFee),color:'#e67e22'},
                {label:'ì›” ì´ìˆ˜ì…',val:fMan(totalRent+totalFee),color:'#e74c3c'}
              ].map(({label,val,color})=>(
                <div key={label} className="card" style={{padding:'14px',borderLeft:`5px solid ${color}`}}>
                  <div style={{fontSize:'11px',color:'#7f8c8d',marginBottom:'4px'}}>{label}</div>
                  <div style={{fontSize:'16px',fontWeight:'bold',color}}>{val}</div>
                </div>
              ))}
            </div>
            {/* ì •ë ¬ */}
            <div style={{display:'flex',gap:'8px',marginBottom:'12px',alignItems:'center'}}>
              <span style={{fontSize:'13px',color:'#7f8c8d',fontWeight:'bold'}}>ì •ë ¬:</span>
              {[{k:'room',l:'ğŸ  í˜¸ìˆ˜ìˆœ'},{k:'payment_day',l:'ğŸ“… ë‚©ì…ì¼ìˆœ'}].map(({k,l})=>(
                <button key={k} onClick={()=>setTenantSort(k)} style={{padding:'7px 14px',background:tenantSort===k?'#2c3e50':'white',color:tenantSort===k?'white':'#2c3e50',border:'2px solid #2c3e50',borderRadius:'8px',cursor:'pointer',fontSize:'13px',fontWeight:'bold'}}>
                  {l}
                </button>
              ))}
            </div>
            {tenants.length===0?(
              <div className="card" style={{padding:'60px',textAlign:'center',color:'#95a5a6'}}>
                <div style={{fontSize:'48px',marginBottom:'12px'}}>ğŸ“</div><p>ë“±ë¡ëœ ì„ì°¨ì¸ì´ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
            ):(
              <div className="card" style={{overflow:'auto'}}>
                <table style={{width:'100%',borderCollapse:'collapse',minWidth:'720px'}}>
                  <thead style={{background:'#34495e',color:'white'}}>
                    <tr>
                      {['í˜¸ìˆ˜','ì´ë¦„','ì—°ë½ì²˜','ë³´ì¦ê¸ˆ','ì›”ì„¸','ê´€ë¦¬ë¹„','ë‚©ì…ì¼',`${selectedMonth} ìˆ˜ë‚©í˜„í™©`,'ê´€ë¦¬'].map(h=>(
                        <th key={h} style={{padding:'13px 10px',textAlign:'left',fontSize:'13px'}}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {sortedTenants.map((t,i)=>{
                      const rentPaid=payments.some(p=>p.tenant_id===t.id&&p.year_month===selectedMonth&&p.type==='rent');
                      const feePaid=payments.some(p=>p.tenant_id===t.id&&p.year_month===selectedMonth&&p.type==='fee');
                      return (
                        <tr key={t.id} style={{borderBottom:'1px solid #f0f0f0',background:i%2===0?'white':'#fafafa'}}>
                          <td style={{padding:'12px 10px',fontWeight:'bold',color:'#3498db'}}>{t.room}</td>
                          <td style={{padding:'12px 10px'}}>{t.name}</td>
                          <td style={{padding:'12px 10px',fontSize:'13px'}}>{t.contact}</td>
                          <td style={{padding:'12px 10px',fontSize:'13px'}}>{fMan(t.deposit)}</td>
                          <td style={{padding:'12px 10px',fontSize:'13px'}}>{fMan(t.monthly_rent)}</td>
                          <td style={{padding:'12px 10px',fontSize:'13px'}}>{fMan(t.maintenance_fee)}</td>
                          <td style={{padding:'12px 10px'}}><span style={{background:'#eaf4ff',color:'#3498db',padding:'3px 8px',borderRadius:'20px',fontSize:'12px',fontWeight:'bold'}}>ë§¤ì›” {t.payment_day}ì¼</span></td>
                          <td style={{padding:'12px 10px'}}>
                            <div style={{display:'flex',gap:'4px',flexWrap:'wrap'}}>
                              <span style={{background:rentPaid?'#d5f5e3':'#fdeaea',color:rentPaid?'#27ae60':'#e74c3c',padding:'3px 8px',borderRadius:'6px',fontSize:'12px',fontWeight:'bold'}}>
                                {rentPaid?'âœ…ì›”ì„¸':'âŒì›”ì„¸'}
                              </span>
                              <span style={{background:feePaid?'#d5f5e3':'#fef3e2',color:feePaid?'#27ae60':'#e67e22',padding:'3px 8px',borderRadius:'6px',fontSize:'12px',fontWeight:'bold'}}>
                                {feePaid?'âœ…ê´€ë¦¬ë¹„':'âŒê´€ë¦¬ë¹„'}
                              </span>
                            </div>
                          </td>
                          <td style={{padding:'12px 10px'}}>
                            <div style={{display:'flex',gap:'4px',flexWrap:'wrap'}}>
                              <button className="btn" onClick={()=>setPayTenant(t)} style={{padding:'6px 10px',background:'#27ae60',color:'white',fontSize:'12px'}}>ğŸ’° ìˆ˜ë‚©</button>
                              <button className="btn" onClick={()=>openModal('tenant',t)} style={{padding:'6px 10px',background:'#3498db',color:'white',fontSize:'12px'}}>ìˆ˜ì •</button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                  <tfoot>
                    <tr style={{background:'#2c3e50',color:'white',fontWeight:'bold'}}>
                      <td style={{padding:'13px 10px'}} colSpan="3">í•©ê³„ ({tenants.length}ëª…)</td>
                      <td style={{padding:'13px 10px',fontSize:'13px'}}>{fMan(totalDep)}</td>
                      <td style={{padding:'13px 10px',fontSize:'13px'}}>{fMan(totalRent)}</td>
                      <td style={{padding:'13px 10px',fontSize:'13px'}}>{fMan(totalFee)}</td>
                      <td style={{padding:'13px 10px'}} colSpan="3">ì›” ì´ìˆ˜ì… {fMan(totalRent+totalFee)}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            )}
          </div>
        )}

        {/* â”€â”€ ì§€ì¶œ â”€â”€ */}
        {!loading&&activeTab==='expenses'&&(
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px',flexWrap:'wrap',gap:'10px'}}>
              <h2 style={{fontSize:'26px',color:'#2c3e50',fontWeight:'bold'}}>ğŸ’¸ ì§€ì¶œ ê´€ë¦¬</h2>
              <div style={{display:'flex',gap:'10px',alignItems:'center',flexWrap:'wrap'}}>
                <input type="month" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)} style={{padding:'8px 12px',fontSize:'14px',borderRadius:'8px',border:'2px solid #e74c3c'}}/>
                <button className="btn" onClick={()=>openModal('expense')} style={{padding:'11px 20px',background:'#e74c3c',color:'white',fontSize:'14px'}}>+ ìƒˆ ì§€ì¶œ</button>
              </div>
            </div>
            <div className="card" style={{padding:'18px',marginBottom:'14px',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <div><div style={{fontSize:'12px',color:'#7f8c8d'}}>ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ</div><div style={{fontSize:'32px',fontWeight:'bold',color:'#e74c3c'}}>{fMan(totalExp)}</div></div>
              <div style={{fontSize:'40px'}}>ğŸ’¸</div>
            </div>
            <div className="card" style={{overflow:'auto'}}>
              <table style={{width:'100%',borderCollapse:'collapse',minWidth:'500px'}}>
                <thead style={{background:'#e74c3c',color:'white'}}>
                  <tr>{['ë‚ ì§œ','ì¹´í…Œê³ ë¦¬','ê¸ˆì•¡','ì„¤ëª…','ê´€ë¦¬'].map(h=><th key={h} style={{padding:'12px 10px',textAlign:'left',fontSize:'13px'}}>{h}</th>)}</tr>
                </thead>
                <tbody>
                  {curExp.length===0?<tr><td colSpan="5" style={{padding:'40px',textAlign:'center',color:'#95a5a6'}}>ì´ë²ˆ ë‹¬ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</td></tr>:
                    curExp.map((exp,i)=>(
                      <tr key={exp.id} style={{borderBottom:'1px solid #f0f0f0',background:i%2===0?'white':'#fff8f8'}}>
                        <td style={{padding:'12px 10px',fontSize:'13px'}}>{exp.date}</td>
                        <td style={{padding:'12px 10px'}}><span style={{background:'#fdeaea',color:'#e74c3c',padding:'3px 8px',borderRadius:'6px',fontSize:'12px'}}>{exp.category_name}</span></td>
                        <td style={{padding:'12px 10px',fontWeight:'bold',color:'#e74c3c',fontSize:'14px'}}>{fNum(exp.amount)}ì›</td>
                        <td style={{padding:'12px 10px',color:'#7f8c8d',fontSize:'13px'}}>{exp.description}</td>
                        <td style={{padding:'12px 10px'}}>
                          <button className="btn" onClick={()=>openModal('expense',exp)} style={{padding:'5px 9px',background:'#3498db',color:'white',fontSize:'12px',marginRight:'4px'}}>ìˆ˜ì •</button>
                          <button className="btn" onClick={()=>deleteItem('expenses',exp.id)} style={{padding:'5px 9px',background:'#e74c3c',color:'white',fontSize:'12px'}}>ì‚­ì œ</button>
                        </td>
                      </tr>
                    ))
                  }
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* â”€â”€ ëŒ€ì¶œ â”€â”€ */}
        {!loading&&activeTab==='loans'&&(
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'18px',flexWrap:'wrap',gap:'10px'}}>
              <h2 style={{fontSize:'26px',color:'#2c3e50',fontWeight:'bold'}}>ğŸ¦ ëŒ€ì¶œ ê´€ë¦¬</h2>
              <button className="btn" onClick={()=>openModal('loan')} style={{padding:'11px 20px',background:'#c0392b',color:'white',fontSize:'14px'}}>+ ìƒˆ ëŒ€ì¶œ</button>
            </div>
            <div className="stat-grid" style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'12px',marginBottom:'18px'}}>
              {[
                {label:'ì´ ëŒ€ì¶œì”ì•¡',val:fUk(totalLoan),color:'#c0392b'},
                {label:'ì›” ì´ì í•©ê³„',val:fMan(totalMInt),color:'#e67e22'},
                {label:'ì—° ì´ì í•©ê³„',val:fMan(totalMInt*12),color:'#f39c12'}
              ].map(({label,val,color})=>(
                <div key={label} className="card" style={{padding:'18px',borderLeft:`5px solid ${color}`}}>
                  <div style={{fontSize:'12px',color:'#7f8c8d',marginBottom:'6px'}}>{label}</div>
                  <div style={{fontSize:'22px',fontWeight:'bold',color}}>{val}</div>
                </div>
              ))}
            </div>
            {loans.length===0?(
              <div className="card" style={{padding:'60px',textAlign:'center',color:'#95a5a6'}}><div style={{fontSize:'48px',marginBottom:'12px'}}>ğŸ¦</div><p>ë“±ë¡ëœ ëŒ€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</p></div>
            ):(
              <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(300px,1fr))',gap:'14px'}}>
                {loans.map(loan=>{
                  const yi=(loan.remaining_amount||0)*(loan.final_rate||0);
                  const mi=yi/12;
                  return (
                    <div key={loan.id} className="card" style={{overflow:'hidden'}}>
                      <div style={{background:'#2c3e50',color:'white',padding:'16px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                        <div><div style={{fontSize:'17px',fontWeight:'bold'}}>ğŸ¦ {loan.lender_name}</div><div style={{fontSize:'11px',opacity:0.7,marginTop:'2px'}}>{loan.loan_type==='bank'?'ì€í–‰ëŒ€ì¶œ':loan.loan_type==='personal'?'ê°œì¸ì°¨ì…':'ê¸°íƒ€'}</div></div>
                        <div style={{display:'flex',gap:'6px'}}>
                          <button className="btn" onClick={()=>openModal('loan',loan)} style={{padding:'6px 10px',background:'#3498db',color:'white',fontSize:'12px'}}>ìˆ˜ì •</button>
                          <button className="btn" onClick={()=>deleteItem('loans',loan.id)} style={{padding:'6px 10px',background:'#e74c3c',color:'white',fontSize:'12px'}}>ì‚­ì œ</button>
                        </div>
                      </div>
                      <div style={{padding:'18px'}}>
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'10px',marginBottom:'14px'}}>
                          <div><div style={{fontSize:'11px',color:'#7f8c8d',marginBottom:'3px'}}>ëŒ€ì¶œì”ì•¡</div><div style={{fontSize:'18px',fontWeight:'bold',color:'#c0392b'}}>{fUk(loan.remaining_amount)}</div><div style={{fontSize:'11px',color:'#95a5a6'}}>{fNum(loan.remaining_amount)}ì›</div></div>
                          <div><div style={{fontSize:'11px',color:'#7f8c8d',marginBottom:'3px'}}>ê¸ˆë¦¬</div><div style={{fontSize:'18px',fontWeight:'bold',color:'#2c3e50'}}>{((loan.final_rate||0)*100).toFixed(2)}%</div></div>
                        </div>
                        <div style={{background:'#fef9f0',border:'2px solid #f39c12',borderRadius:'10px',padding:'12px'}}>
                          <div style={{fontSize:'12px',fontWeight:'bold',color:'#2c3e50',marginBottom:'8px'}}>ğŸ“Š ì´ì ìë™ê³„ì‚°</div>
                          <div style={{display:'flex',justifyContent:'space-between',marginBottom:'5px'}}><span style={{color:'#7f8c8d',fontSize:'12px'}}>ì—° ì´ì</span><strong style={{color:'#e67e22',fontSize:'13px'}}>{fNum(yi)}ì›</strong></div>
                          <div style={{display:'flex',justifyContent:'space-between'}}><span style={{color:'#7f8c8d',fontSize:'12px'}}>ì›” ì´ì</span><strong style={{color:'#e74c3c',fontSize:'16px'}}>{fNum(mi)}ì›</strong></div>
                        </div>
                        {loan.note&&<div style={{marginTop:'8px',padding:'8px',background:'#f8f9fa',borderRadius:'8px',fontSize:'12px',color:'#7f8c8d'}}>ğŸ“ {loan.note}</div>}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* â”€â”€ ê´€ë¦¬ì â”€â”€ */}
        {!loading&&activeTab==='admins'&&(
          <div>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'18px',flexWrap:'wrap',gap:'10px'}}>
              <h2 style={{fontSize:'26px',color:'#2c3e50',fontWeight:'bold'}}>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h2>
              <button className="btn" onClick={()=>openModal('admin')} style={{padding:'11px 20px',background:'#8e44ad',color:'white',fontSize:'14px'}}>+ ê´€ë¦¬ì ì¶”ê°€</button>
            </div>
            <div className="card" style={{overflow:'auto',marginBottom:'18px'}}>
              <table style={{width:'100%',borderCollapse:'collapse'}}>
                <thead style={{background:'#8e44ad',color:'white'}}>
                  <tr>{['ì´ë¦„','ë¹„ë°€ë²ˆí˜¸','ê¶Œí•œ','ìƒíƒœ','ê´€ë¦¬'].map(h=><th key={h} style={{padding:'13px 14px',textAlign:'left',fontSize:'13px'}}>{h}</th>)}</tr>
                </thead>
                <tbody>
                  {admins.map((a,i)=>(
                    <tr key={a.id} style={{borderBottom:'1px solid #f0f0f0',background:i%2===0?'white':'#fafafa'}}>
                      <td style={{padding:'13px 14px',fontWeight:'bold'}}>ğŸ‘¤ {a.name}</td>
                      <td style={{padding:'13px 14px'}}><span style={{background:'#f0f0f0',padding:'4px 10px',borderRadius:'6px',fontFamily:'monospace'}}>â€¢â€¢â€¢â€¢</span></td>
                      <td style={{padding:'13px 14px'}}><span style={{background:a.role==='super'?'#e74c3c':'#3498db',color:'white',padding:'3px 10px',borderRadius:'20px',fontSize:'12px',fontWeight:'bold'}}>{a.role==='super'?'ìµœê³ ê´€ë¦¬ì':'ê´€ë¦¬ì'}</span></td>
                      <td style={{padding:'13px 14px'}}><span style={{background:a.active?'#27ae60':'#95a5a6',color:'white',padding:'3px 10px',borderRadius:'20px',fontSize:'12px',fontWeight:'bold'}}>{a.active?'í™œì„±':'ë¹„í™œì„±'}</span></td>
                      <td style={{padding:'13px 14px',display:'flex',gap:'6px'}}>
                        <button className="btn" onClick={()=>openModal('admin',a)} style={{padding:'6px 10px',background:'#3498db',color:'white',fontSize:'12px'}}>ìˆ˜ì •</button>
                        {a.id!==admin.id&&<button className="btn" onClick={()=>deleteItem('admins',a.id)} style={{padding:'6px 10px',background:'#e74c3c',color:'white',fontSize:'12px'}}>ì‚­ì œ</button>}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="card" style={{padding:'18px',background:'#f0f8ff',border:'2px solid #3498db'}}>
              <h3 style={{fontSize:'15px',color:'#2c3e50',marginBottom:'12px'}}>ğŸ“± ì•± ì„¤ì¹˜ ë°©ë²•</h3>
              <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))',gap:'10px'}}>
                {[{icon:'ğŸ¤–',title:'ì•ˆë“œë¡œì´ë“œ',desc:'Chrome â†’ ë©”ë‰´(â‹®) â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€"'},
                  {icon:'ğŸ',title:'ì•„ì´í°',desc:'Safari â†’ ê³µìœ (ğŸ“¤) â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€"'},
                  {icon:'ğŸ’»',title:'PC',desc:'Chrome â†’ ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ âŠ• í´ë¦­'}].map(({icon,title,desc})=>(
                  <div key={title} style={{background:'white',padding:'12px',borderRadius:'10px'}}>
                    <div style={{fontSize:'22px',marginBottom:'5px'}}>{icon}</div>
                    <div style={{fontWeight:'bold',marginBottom:'3px',color:'#2c3e50',fontSize:'14px'}}>{title}</div>
                    <div style={{fontSize:'12px',color:'#7f8c8d',lineHeight:'1.5'}}>{desc}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>

      {/* ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ */}
      <div id="mob-nav">
        {tabs.map(({id,icon,label})=>(
          <button key={id} className={`mob-btn${activeTab===id?' active':''}`} onClick={()=>setActiveTab(id)}>
            <span>{icon}</span><span>{label}</span>
          </button>
        ))}
      </div>

      {/* ìˆ˜ë‚© ê´€ë¦¬ ëª¨ë‹¬ */}
      {payTenant && (
        <PaymentModal
          tenant={payTenant}
          payments={payments}
          onClose={()=>setPayTenant(null)}
          onRefresh={loadPayments}
        />
      )}

      {/* ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ */}
      {showModal&&(
        <div className="modal-wrap" style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px'}}
          onClick={e=>{if(e.target===e.currentTarget)setShowModal(false);}}>
          <div className="modal-inner card" style={{width:'100%',maxWidth:'500px',maxHeight:'88vh',overflowY:'auto',padding:'24px',position:'relative'}}
            onClick={e=>e.stopPropagation()}>
            <button onClick={()=>setShowModal(false)} style={{position:'absolute',top:'14px',right:'14px',background:'#e74c3c',color:'white',border:'none',borderRadius:'50%',width:'34px',height:'34px',fontSize:'20px',cursor:'pointer',fontWeight:'bold',lineHeight:1}}>Ã—</button>
            <h3 style={{fontSize:'19px',color:'#2c3e50',marginBottom:'18px'}}>{editItem?'ìˆ˜ì •':'ìƒˆ ë“±ë¡'} - {{tenant:'ì„ì°¨ì¸',expense:'ì§€ì¶œ',loan:'ëŒ€ì¶œ',admin:'ê´€ë¦¬ì'}[modalType]}</h3>
            <form onSubmit={saveData}>
              {modalType==='tenant'&&<>
                {[{l:'ğŸ  í˜¸ìˆ˜',f:'room',t:'text',p:'ì˜ˆ: 301í˜¸'},{l:'ğŸ‘¤ ì´ë¦„',f:'name',t:'text',p:'ì˜ˆ: ê¹€ë¯¼ìˆ˜'},{l:'ğŸ“ ì—°ë½ì²˜',f:'contact',t:'text',p:'ì˜ˆ: 010-1234-5678'},{l:'ğŸ’° ë³´ì¦ê¸ˆ (ì›)',f:'deposit',t:'number',p:''},{l:'ğŸ¦ ì›”ì„¸ (ì›)',f:'monthly_rent',t:'number',p:''},{l:'ğŸ”§ ê´€ë¦¬ë¹„ (ì›)',f:'maintenance_fee',t:'number',p:''},{l:'ğŸ“… ë‚©ì…ì¼ (1~31)',f:'payment_day',t:'number',p:''},{l:'ğŸšª ì…ì£¼ì¼',f:'move_in_date',t:'date',p:''},{l:'ğŸ“‹ ê³„ì•½ë§Œë£Œì¼',f:'contract_end',t:'date',p:''}].map(({l,f,t,p})=>(
                  <div key={f}><label style={s.label}>{l}</label><input type={t} placeholder={p} value={formData[f]||''} onChange={e=>setFormData({...formData,[f]:t==='number'?(parseInt(e.target.value)||0):e.target.value})} style={s.input} required/></div>
                ))}
              </>}
              {modalType==='expense'&&<>
                <label style={s.label}>ğŸ“… ë‚ ì§œ</label><input type="date" value={formData.date||''} onChange={e=>setFormData({...formData,date:e.target.value})} style={s.input} required/>
                <label style={s.label}>ğŸ“‚ ì¹´í…Œê³ ë¦¬</label>
                <select value={formData.category_name||''} onChange={e=>setFormData({...formData,category_name:e.target.value})} style={s.input} required>
                  <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                  {expenseCategories.map(c=><option key={c.id} value={c.name}>{c.name}</option>)}
                </select>
                <label style={s.label}>ğŸ’° ê¸ˆì•¡ (ì›)</label><input type="number" value={formData.amount||''} onChange={e=>setFormData({...formData,amount:parseInt(e.target.value)||0})} style={s.input} required/>
                <label style={s.label}>ğŸ“ ì„¤ëª…</label><input value={formData.description||''} onChange={e=>setFormData({...formData,description:e.target.value})} style={s.input}/>
              </>}
              {modalType==='loan'&&<>
                <label style={s.label}>ğŸ¦ ëŒ€ì¶œì²˜</label><input placeholder="ì˜ˆ: ìˆ˜í˜‘ì€í–‰" value={formData.lender_name||''} onChange={e=>setFormData({...formData,lender_name:e.target.value})} style={s.input} required/>
                <label style={s.label}>ğŸ’° ëŒ€ì¶œì”ì•¡ (ì›)</label><input type="number" value={formData.remaining_amount||''} onChange={e=>setFormData({...formData,remaining_amount:parseInt(e.target.value)||0})} style={{...s.input,borderColor:'#c0392b'}} required/>
                <label style={s.label}>ğŸ“Š ê¸ˆë¦¬ (%)</label><input type="number" step="0.01" min="0" max="100" placeholder="ì˜ˆ: 2.45" value={formData.final_rate?(formData.final_rate*100).toFixed(2):''} onChange={e=>setFormData({...formData,final_rate:parseFloat(e.target.value)/100||0})} style={{...s.input,borderColor:'#e67e22'}} required/>
                {formData.remaining_amount>0&&formData.final_rate>0&&(
                  <div style={{background:'#fef9f0',border:'2px solid #f39c12',borderRadius:'10px',padding:'12px',marginBottom:'12px'}}>
                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px'}}><span style={{color:'#7f8c8d',fontSize:'13px'}}>ì—° ì´ì</span><strong style={{color:'#e67e22'}}>{fNum(formData.remaining_amount*formData.final_rate)}ì›</strong></div>
                    <div style={{display:'flex',justifyContent:'space-between'}}><span style={{color:'#7f8c8d',fontSize:'13px'}}>ì›” ì´ì</span><strong style={{color:'#e74c3c',fontSize:'16px'}}>{fNum(formData.remaining_amount*formData.final_rate/12)}ì›</strong></div>
                  </div>
                )}
                <label style={s.label}>ğŸ·ï¸ ìœ í˜•</label>
                <select value={formData.loan_type||'bank'} onChange={e=>setFormData({...formData,loan_type:e.target.value})} style={s.input}>
                  <option value="bank">ì€í–‰ ëŒ€ì¶œ</option><option value="personal">ê°œì¸ ì°¨ì…</option><option value="other">ê¸°íƒ€</option>
                </select>
                <label style={s.label}>ğŸ“… ì‹œì‘ì¼</label><input type="date" value={formData.start_date||''} onChange={e=>setFormData({...formData,start_date:e.target.value})} style={s.input}/>
                <label style={s.label}>ğŸ“ ë©”ëª¨</label><input value={formData.note||''} onChange={e=>setFormData({...formData,note:e.target.value})} style={s.input}/>
              </>}
              {modalType==='admin'&&<>
                <label style={s.label}>ğŸ‘¤ ì´ë¦„</label><input placeholder="ì˜ˆ: ê¹€ì² ìˆ˜" value={formData.name||''} onChange={e=>setFormData({...formData,name:e.target.value})} style={s.input} required/>
                <label style={s.label}>ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì)</label><input type="number" placeholder="ì˜ˆ: 5678" value={formData.passcode||''} onChange={e=>setFormData({...formData,passcode:e.target.value})} style={s.input} required/>
                <label style={s.label}>ê¶Œí•œ</label>
                <select value={formData.role||'admin'} onChange={e=>setFormData({...formData,role:e.target.value})} style={s.input}>
                  <option value="super">ìµœê³ ê´€ë¦¬ì</option><option value="admin">ê´€ë¦¬ì</option>
                </select>
                <label style={s.label}>ìƒíƒœ</label>
                <select value={formData.active?'true':'false'} onChange={e=>setFormData({...formData,active:e.target.value==='true'})} style={s.input}>
                  <option value="true">í™œì„±</option><option value="false">ë¹„í™œì„±</option>
                </select>
              </>}
              <div style={{display:'flex',gap:'10px',marginTop:'14px'}}>
                <button type="button" className="btn" onClick={()=>setShowModal(false)} style={{flex:1,padding:'13px',background:'#95a5a6',color:'white',fontSize:'15px'}}>ì·¨ì†Œ</button>
                <button type="submit" className="btn" style={{flex:1,padding:'13px',background:'#27ae60',color:'white',fontSize:'15px'}}>{editItem?'ìˆ˜ì •':'ë“±ë¡'}</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
