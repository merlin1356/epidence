<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2c3e50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EPIDENCE">
  <title>EPIDENCE ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤ | ì„ëŒ€ê´€ë¦¬ì‹œìŠ¤í…œ</title>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <script type="text/babel">
const { useState, useEffect } = React;
const { createClient } = supabase;


// ì‹¤ì œ EPIDENCE ë¡œê³ 
const LOGO_BASE64 = 'data:image/jpeg;base64,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';

const sb = createClient(
  'https://fkvktmkcoyfvtsluzmeo.supabase.co',
  'sb_publishable_HBGYuYTBxwoeSBNG204NCw_gNd3fIfv'
);

const fNum = n => Math.round(n||0).toLocaleString('ko-KR');
const fMan = n => Math.round((n||0)/10000) + 'ë§Œ';
const fUk  = n => ((n||0)/100000000).toFixed(1) + 'ì–µ';
const thisMonth = () => new Date().toISOString().slice(0,7);

const css = `
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
  body{font-family:'Malgun Gothic',sans-serif;background:#f0f2f5;-webkit-text-size-adjust:100%;overflow-x:hidden;}
  .btn{border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:12px;white-space:nowrap;}
  .btn:active{opacity:0.7;transform:scale(0.98);}
  .card{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);}
  
  /* ì „í™” ë§í¬ */
  a[href^="tel:"]{transition:all 0.2s ease;}
  a[href^="tel:"]:hover{opacity:0.8;transform:scale(1.02);}
  a[href^="tel:"]:active{transform:scale(0.98);}
  
  /* ìˆ˜ë‚© ëª¨ë‹¬ */
  .pay-tab{padding:5px 10px;border:2px solid #ddd;border-radius:14px;background:white;font-size:11px;font-weight:bold;color:#7f8c8d;cursor:pointer;white-space:nowrap;flex-shrink:0;}
  .pay-tab.active{background:#3498db;border-color:#3498db;color:white;}
  .pay-tab-fee.active{background:#e67e22;border-color:#e67e22;}
  .pay-tab-other.active{background:#9b59b6;border-color:#9b59b6;}
  .pay-btn-unpaid{background:#ecf0f1;color:#7f8c8d;border:2px dashed #bdc3c7;border-radius:6px;padding:5px 8px;font-size:11px;font-weight:bold;width:100%;cursor:pointer;}
  .pay-btn-paid{background:#d5f5e3;color:#27ae60;border:2px solid #27ae60;border-radius:6px;padding:5px 8px;font-size:11px;font-weight:bold;width:100%;}
  .pay-btn-cancel{background:#fdeaea;color:#e74c3c;border:2px solid #e74c3c;border-radius:6px;padding:3px 6px;font-size:10px;cursor:pointer;margin-top:3px;width:100%;}
  
  
  @media(max-width:768px){
    #sidebar{display:none!important;}
    #main{margin-left:0!important;padding:10px!important;padding-bottom:70px!important;}
    #mob-nav{display:flex!important;}
    .stat-grid{grid-template-columns:repeat(2,1fr)!important;gap:6px!important;}
    h2{font-size:18px!important;margin-bottom:10px!important;}
    .modal-inner{width:100%!important;max-width:100%!important;border-radius:16px 16px 0 0!important;max-height:88vh!important;margin:0!important;}
    .modal-wrap{align-items:flex-end!important;padding:0!important;}
  }
  
  @media(min-width:769px){
    #mob-nav{display:none!important;}
  }
  
  /* ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ */
  #mob-nav{position:fixed;bottom:0;left:0;right:0;background:#2c3e50;z-index:500;padding:3px 0;display:none;}
  .mob-btn{flex:1;display:flex;flex-direction:column;align-items:center;background:none;border:none;color:#95a5a6;padding:3px;font-size:9px;gap:1px;cursor:pointer;}
  .mob-btn span:first-child{font-size:17px;line-height:1;}
  .mob-btn.active{color:#3498db;}
  
  /* ë¡œê·¸ì¸ */
  .login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#2c3e50,#3498db);padding:16px;}
  .login-box{background:white;border-radius:16px;padding:28px;width:100%;max-width:340px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);}
  .pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:14px 0;}
  .pin-btn{padding:14px;font-size:18px;font-weight:bold;background:#f8f9fa;border:2px solid #ecf0f1;border-radius:8px;cursor:pointer;color:#2c3e50;}
  .pin-btn:active{background:#3498db;color:white;}
`;

function LoginScreen({ onLogin }) {
  const [pin, setPin] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleNum = n => {
    if (pin.length >= 6 || loading) return;
    const next = pin + n;
    setPin(next); setError('');
    if (next.length >= 4) checkPin(next);
  };

  const checkPin = async code => {
    setLoading(true);
    const { data } = await sb.from('admins').select('*').eq('passcode', code).eq('active', true);
    if (data && data.length > 0) { onLogin(data[0]); }
    else { setTimeout(() => { setError('âŒ ì˜¤ë¥˜'); setPin(''); setLoading(false); }, 400); }
  };

  return (
    <div className="login-wrap">
      <div className="login-box">
        <div style={{ 
          width: '100px', 
          height: '100px', 
          borderRadius: '50%', 
          background: 'white', 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'center',
          marginBottom: '16px',
          boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
        }}>
          <img src={LOGO_BASE64} alt="EPIDENCE" style={{ 
            width: '70%', 
            height: '70%', 
            objectFit: 'contain'
          }} />
        </div>
        <h1 style={{ fontSize: '24px', color: '#2c3e50', marginBottom: '4px', fontWeight: 'bold', letterSpacing: '2px' }}>EPIDENCE</h1>
        <p style={{ color: '#7f8c8d', fontSize: '12px', marginBottom: '18px' }}>ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤ ì„ëŒ€ê´€ë¦¬</p>
        <div style={{ background: '#f8f9fa', borderRadius: '8px', padding: '10px', marginBottom: '6px', minHeight: '44px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          {loading ? <span style={{ color: '#27ae60', fontSize: '15px' }}>âœ” í™•ì¸ì¤‘...</span> :
            <span style={{ fontSize: '26px', letterSpacing: '7px', color: '#2c3e50' }}>
              {pin ? pin.split('').map(() => 'â—').join(' ') : <span style={{ fontSize: '12px', color: '#bdc3c7' }}>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</span>}
            </span>}
        </div>
        {error && <div style={{ color: '#e74c3c', fontSize: '12px', marginBottom: '6px', fontWeight: 'bold' }}>{error}</div>}
        <div className="pin-grid">
          {[1,2,3,4,5,6,7,8,9].map(n => <button key={n} className="pin-btn" onClick={() => handleNum(String(n))}>{n}</button>)}
          <button className="pin-btn" onClick={() => { setPin(''); setError(''); }} style={{ color: '#e74c3c' }}>C</button>
          <button className="pin-btn" onClick={() => handleNum('0')}>0</button>
          <button className="pin-btn" onClick={() => setPin(p => p.slice(0, -1))} style={{ color: '#e74c3c' }}>âŒ«</button>
        </div>
        <p style={{ fontSize: '10px', color: '#bdc3c7', marginTop: '6px' }}>ê´€ë¦¬ì ì½”ë“œ ì…ë ¥</p>
      </div>
    </div>
  );
}

// â”€â”€ ëŒ€ì¶œ ìƒì„¸ ê´€ë¦¬ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoanDetailModal({ loan, loanPayments, onClose, onRefresh }) {
  const [editing, setEditing] = useState(false);
  const [loanData, setLoanData] = useState({ ...loan });
  const [paymentForm, setPaymentForm] = useState({ payment_date: new Date().toISOString().split('T')[0], amount: '', note: '' });
  const [saving, setSaving] = useState(false);

  const payments = loanPayments.filter(p => p.loan_id === loan.id).sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date));
  const totalPaid = payments.reduce((s, p) => s + (p.amount || 0), 0);
  const currentBalance = (loan.initial_amount || loan.remaining_amount || 0) - totalPaid;
  const yearlyInterest = currentBalance * (loanData.final_rate || 0);
  const monthlyInterest = yearlyInterest / 12;

  const handleSaveLoan = async () => {
    setSaving(true);
    try {
      const { error } = await sb.from('loans').update({ remaining_amount: currentBalance, final_rate: loanData.final_rate }).eq('id', loan.id);
      if (error) { alert('ì‹¤íŒ¨: ' + error.message); setSaving(false); return; }
      await onRefresh(); setEditing(false); setSaving(false);
    } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); setSaving(false); }
  };

  const handleAddPayment = async () => {
    if (!paymentForm.amount || parseInt(paymentForm.amount) <= 0) { alert('ìƒí™˜ì•¡ ì…ë ¥'); return; }
    setSaving(true);
    try {
      const { error } = await sb.from('loan_payments').insert([{ loan_id: loan.id, payment_date: paymentForm.payment_date, amount: parseInt(paymentForm.amount), note: paymentForm.note || 'ëŒ€ì¶œ ìƒí™˜' }]);
      if (error) { alert('ì‹¤íŒ¨: ' + error.message); setSaving(false); return; }
      const newBalance = currentBalance - parseInt(paymentForm.amount);
      await sb.from('loans').update({ remaining_amount: newBalance }).eq('id', loan.id);
      await onRefresh(); setPaymentForm({ payment_date: new Date().toISOString().split('T')[0], amount: '', note: '' }); setSaving(false);
    } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); setSaving(false); }
  };

  const handleDeletePayment = async (paymentId, amount) => {
    if (!window.confirm('ìƒí™˜ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    setSaving(true);
    try {
      const { error } = await sb.from('loan_payments').delete().eq('id', paymentId);
      if (error) { alert('ì‹¤íŒ¨: ' + error.message); setSaving(false); return; }
      const newBalance = currentBalance + amount;
      await sb.from('loans').update({ remaining_amount: newBalance }).eq('id', loan.id);
      await onRefresh(); setSaving(false);
    } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); setSaving(false); }
  };

  return (
    <div onClick={e => { if (e.target === e.currentTarget) onClose(); }}
      style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.65)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '16px' }}>
      <div style={{ background: 'white', borderRadius: '16px', width: '100%', maxWidth: '600px', maxHeight: '90vh', overflowY: 'auto' }}>
        <div style={{ background: '#2c3e50', color: 'white', padding: '16px', borderRadius: '16px 16px 0 0', position: 'sticky', top: 0, zIndex: 10 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ fontSize: '18px', fontWeight: 'bold', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>ğŸ¦ {loan.lender_name}</div>
              <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '2px' }}>ëŒ€ì¶œ ìƒì„¸ ê´€ë¦¬</div>
            </div>
            <button onClick={onClose} style={{ background: '#e74c3c', color: 'white', border: 'none', borderRadius: '50%', width: '30px', height: '30px', fontSize: '18px', cursor: 'pointer', fontWeight: 'bold', flexShrink: 0, marginLeft: '10px' }}>Ã—</button>
          </div>
        </div>
        <div style={{ padding: '16px' }}>
          <div style={{ background: '#f8f9fa', borderRadius: '10px', padding: '14px', marginBottom: '14px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
              <h3 style={{ fontSize: '15px', color: '#2c3e50' }}>ğŸ’° ëŒ€ì¶œ ì •ë³´</h3>
              <button onClick={() => setEditing(!editing)} style={{ padding: '5px 10px', background: editing ? '#95a5a6' : '#3498db', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: 'bold' }}>{editing ? 'ì·¨ì†Œ' : 'ìˆ˜ì •'}</button>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '10px' }}>
              <div><div style={{ fontSize: '11px', color: '#7f8c8d', marginBottom: '4px' }}>ì´ˆê¸° ëŒ€ì¶œì•¡</div><div style={{ fontSize: '16px', fontWeight: 'bold', color: '#c0392b' }}>{fNum(loan.initial_amount || loan.remaining_amount)}ì›</div></div>
              <div><div style={{ fontSize: '11px', color: '#7f8c8d', marginBottom: '4px' }}>ì´ ìƒí™˜ì•¡</div><div style={{ fontSize: '16px', fontWeight: 'bold', color: '#27ae60' }}>{fNum(totalPaid)}ì›</div></div>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
              <div><div style={{ fontSize: '11px', color: '#7f8c8d', marginBottom: '4px' }}>í˜„ì¬ ì”ì•¡</div><div style={{ fontSize: '18px', fontWeight: 'bold', color: '#c0392b' }}>{fNum(currentBalance)}ì›</div></div>
              <div><div style={{ fontSize: '11px', color: '#7f8c8d', marginBottom: '4px' }}>ê¸ˆë¦¬ (%)</div>
                {editing ? <input type="number" step="0.01" min="0" max="100" value={(loanData.final_rate * 100).toFixed(2)} onChange={e => setLoanData({ ...loanData, final_rate: parseFloat(e.target.value) / 100 || 0 })} style={{ width: '100%', padding: '6px', border: '2px solid #3498db', borderRadius: '6px', fontSize: '14px', fontWeight: 'bold' }} /> : <div style={{ fontSize: '18px', fontWeight: 'bold', color: '#2c3e50' }}>{((loanData.final_rate || 0) * 100).toFixed(2)}%</div>}
              </div>
            </div>
            {editing && <button onClick={handleSaveLoan} disabled={saving} style={{ width: '100%', marginTop: '10px', padding: '10px', background: '#27ae60', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: 'bold' }}>ğŸ’¾ ì €ì¥</button>}
          </div>
          <div style={{ background: '#fef9f0', border: '2px solid #f39c12', borderRadius: '10px', padding: '12px', marginBottom: '14px' }}>
            <div style={{ fontSize: '13px', fontWeight: 'bold', marginBottom: '8px', color: '#2c3e50' }}>ğŸ“Š ì´ì ìë™ê³„ì‚°</div>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '5px' }}><span style={{ fontSize: '12px', color: '#7f8c8d' }}>ì—° ì´ì</span><strong style={{ color: '#e67e22', fontSize: '14px' }}>{fNum(yearlyInterest)}ì›</strong></div>
            <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ fontSize: '12px', color: '#7f8c8d' }}>ì›” ì´ì</span><strong style={{ color: '#e74c3c', fontSize: '16px' }}>{fNum(monthlyInterest)}ì›</strong></div>
          </div>
          <div style={{ background: '#e8f8f5', borderRadius: '10px', padding: '14px', marginBottom: '14px' }}>
            <h3 style={{ fontSize: '15px', color: '#2c3e50', marginBottom: '10px' }}>ğŸ’¸ ìƒí™˜ ì¶”ê°€</h3>
            <div style={{ marginBottom: '8px' }}><label style={{ display: 'block', fontSize: '11px', fontWeight: 'bold', color: '#2c3e50', marginBottom: '4px' }}>ìƒí™˜ì¼</label><input type="date" value={paymentForm.payment_date} onChange={e => setPaymentForm({ ...paymentForm, payment_date: e.target.value })} style={{ width: '100%', padding: '8px', border: '2px solid #27ae60', borderRadius: '6px', fontSize: '13px' }} /></div>
            <div style={{ marginBottom: '8px' }}><label style={{ display: 'block', fontSize: '11px', fontWeight: 'bold', color: '#2c3e50', marginBottom: '4px' }}>ìƒí™˜ì•¡ (ì›)</label><input type="number" value={paymentForm.amount} onChange={e => setPaymentForm({ ...paymentForm, amount: e.target.value })} placeholder="1000000" style={{ width: '100%', padding: '8px', border: '2px solid #27ae60', borderRadius: '6px', fontSize: '13px' }} /></div>
            <div style={{ marginBottom: '10px' }}><label style={{ display: 'block', fontSize: '11px', fontWeight: 'bold', color: '#2c3e50', marginBottom: '4px' }}>ë©”ëª¨</label><input value={paymentForm.note} onChange={e => setPaymentForm({ ...paymentForm, note: e.target.value })} placeholder="ì¤‘ë„ìƒí™˜..." style={{ width: '100%', padding: '8px', border: '2px solid #ecf0f1', borderRadius: '6px', fontSize: '13px' }} /></div>
            <button onClick={handleAddPayment} disabled={saving} style={{ width: '100%', padding: '10px', background: '#27ae60', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: 'bold' }}>â• ìƒí™˜ ì¶”ê°€</button>
          </div>
          <div>
            <h3 style={{ fontSize: '15px', color: '#2c3e50', marginBottom: '10px' }}>ğŸ“‹ ìƒí™˜ ë‚´ì—­ ({payments.length}ê±´)</h3>
            {payments.length === 0 ? <div style={{ textAlign: 'center', padding: '30px', color: '#95a5a6', fontSize: '13px' }}>ìƒí™˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div> :
              payments.map(p => (
                <div key={p.id} style={{ background: '#f8f9fa', borderRadius: '8px', padding: '10px', marginBottom: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div style={{ flex: 1, minWidth: 0 }}><div style={{ fontSize: '13px', fontWeight: 'bold', color: '#27ae60', marginBottom: '2px' }}>{fNum(p.amount)}ì›</div><div style={{ fontSize: '11px', color: '#7f8c8d' }}>{p.payment_date} Â· {p.note}</div></div>
                  <button onClick={() => handleDeletePayment(p.id, p.amount)} style={{ background: '#e74c3c', color: 'white', border: 'none', borderRadius: '6px', padding: '5px 8px', cursor: 'pointer', fontSize: '11px', fontWeight: 'bold', flexShrink: 0, marginLeft: '8px' }}>ì‚­ì œ</button>
                </div>
              ))}
          </div>
        </div>
      </div>
    </div>
  );
}

function PaymentModal({ tenant, payments, onClose, onRefresh }) {
  const [activeType, setActiveType] = useState('rent');
  const [year, setYear] = useState(new Date().getFullYear());
  const [otherModal, setOtherModal] = useState(null);
  const [otherForm, setOtherForm] = useState({ amount: '', note: '' });
  const [saving, setSaving] = useState(false);
  const [monthlyAmounts, setMonthlyAmounts] = useState({});

  const months = Array.from({ length: 12 }, (_, i) => String(i + 1).padStart(2, '0'));
  const tp = payments.filter(p => p.tenant_id === tenant.id);
  const getPays = (ym, type) => tp.filter(p => p.year_month === ym && p.type === type);
  const isPaid = (ym, type) => getPays(ym, type).length > 0;

  const getAmount = (ym, type) => {
    const key = `${ym}-${type}`;
    if (monthlyAmounts[key] !== undefined) return monthlyAmounts[key];
    return type === 'rent' ? tenant.monthly_rent : tenant.maintenance_fee;
  };

  const setAmount = (ym, type, value) => {
    setMonthlyAmounts({ ...monthlyAmounts, [`${ym}-${type}`]: parseInt(value) || 0 });
  };

  const handlePay = async (ym, type) => {
    if (saving || isPaid(ym, type)) return;
    setSaving(true);
    try {
      const amount = getAmount(ym, type);
      const { error } = await sb.from('payments').insert([{ tenant_id: tenant.id, year_month: ym, type, amount, note: 'ìˆ˜ë‚©ì™„ë£Œ' }]);
      if (error) { alert('ì‹¤íŒ¨: ' + error.message); setSaving(false); return; }
      await onRefresh(); setSaving(false);
    } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); setSaving(false); }
  };

  const handleCancel = async (ym, type) => {
    if (!window.confirm('ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      for (const p of getPays(ym, type)) {
        const { error } = await sb.from('payments').delete().eq('id', p.id);
        if (error) { alert('ì‹¤íŒ¨: ' + error.message); return; }
      }
      await onRefresh();
    } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); }
  };

  const handleOtherSave = async () => {
    if (!otherForm.amount || parseInt(otherForm.amount) <= 0) { alert('ê¸ˆì•¡ ì…ë ¥'); return; }
    setSaving(true);
    try {
      const { error } = await sb.from('payments').insert([{ tenant_id: tenant.id, year_month: otherModal, type: 'other', amount: parseInt(otherForm.amount), note: otherForm.note || 'ê¸°íƒ€' }]);
      if (error) { alert('ì‹¤íŒ¨: ' + error.message); setSaving(false); return; }
      await onRefresh(); setOtherModal(null); setOtherForm({ amount: '', note: '' }); setSaving(false);
    } catch (err) { alert('ì˜¤ë¥˜: ' + err.message); setSaving(false); }
  };

  const yearTotals = { rent: 0, fee: 0, other: 0 };
  months.forEach(m => {
    const ym = `${year}-${m}`;
    getPays(ym, 'rent').forEach(p => yearTotals.rent += p.amount);
    getPays(ym, 'fee').forEach(p => yearTotals.fee += p.amount);
    getPays(ym, 'other').forEach(p => yearTotals.other += p.amount);
  });

  return (
    <div className="modal-wrap" onClick={e => { if (e.target === e.currentTarget) onClose(); }}
      style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.65)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '0' }}>
      <div className="modal-inner" style={{ background: 'white', borderRadius: '14px', width: '100%', maxWidth: '560px', maxHeight: '90vh', overflowY: 'auto' }}>
        <div style={{ background: '#2c3e50', color: 'white', padding: '14px', borderRadius: '14px 14px 0 0', position: 'sticky', top: 0, zIndex: 10 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px' }}>
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ fontSize: '16px', fontWeight: 'bold', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>ğŸ  {tenant.room} {tenant.name}</div>
              <div style={{ fontSize: '11px', opacity: 0.8, marginTop: '2px' }}>ì›”ì„¸ {fMan(tenant.monthly_rent)} / ê´€ë¦¬ë¹„ {fMan(tenant.maintenance_fee)}</div>
            </div>
            <button onClick={onClose} style={{ background: '#e74c3c', color: 'white', border: 'none', borderRadius: '50%', width: '28px', height: '28px', fontSize: '16px', cursor: 'pointer', fontWeight: 'bold', flexShrink: 0, marginLeft: '8px' }}>Ã—</button>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
            <button onClick={() => setYear(y => y - 1)} style={{ background: 'rgba(255,255,255,0.2)', color: 'white', border: 'none', borderRadius: '5px', padding: '3px 8px', cursor: 'pointer', fontSize: '13px' }}>â—€</button>
            <span style={{ fontSize: '14px', fontWeight: 'bold' }}>{year}ë…„</span>
            <button onClick={() => setYear(y => y + 1)} style={{ background: 'rgba(255,255,255,0.2)', color: 'white', border: 'none', borderRadius: '5px', padding: '3px 8px', cursor: 'pointer', fontSize: '13px' }}>â–¶</button>
          </div>
          <div style={{ display: 'flex', gap: '5px', overflowX: 'auto', WebkitOverflowScrolling: 'touch' }}>
            <button className={`pay-tab${activeType === 'rent' ? ' active' : ''}`} onClick={() => setActiveType('rent')}>ğŸ’™ì›”ì„¸</button>
            <button className={`pay-tab pay-tab-fee${activeType === 'fee' ? ' active' : ''}`} onClick={() => setActiveType('fee')}>ğŸ§¡ê´€ë¦¬ë¹„</button>
            <button className={`pay-tab pay-tab-other${activeType === 'other' ? ' active' : ''}`} onClick={() => setActiveType('other')}>ğŸ’œê¸°íƒ€</button>
          </div>
        </div>

        <div style={{ padding: '14px' }}>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3,1fr)', gap: '6px', marginBottom: '12px' }}>
            {[
              { label: 'ì›”ì„¸', val: yearTotals.rent, exp: tenant.monthly_rent * 12, color: '#3498db' },
              { label: 'ê´€ë¦¬ë¹„', val: yearTotals.fee, exp: tenant.maintenance_fee * 12, color: '#e67e22' },
              { label: 'ê¸°íƒ€', val: yearTotals.other, color: '#9b59b6' },
            ].map(({ label, val, exp, color }) => (
              <div key={label} style={{ background: '#f8f9fa', borderRadius: '8px', padding: '8px', borderLeft: `3px solid ${color}` }}>
                <div style={{ fontSize: '9px', color: '#7f8c8d', marginBottom: '2px' }}>{label}</div>
                <div style={{ fontSize: '13px', fontWeight: 'bold', color }}>{fMan(val)}</div>
                {exp && <div style={{ fontSize: '9px', color: val >= exp ? '#27ae60' : '#e74c3c', marginTop: '1px' }}>/ {fMan(exp)} ({Math.round(val / exp * 100)}%)</div>}
              </div>
            ))}
          </div>

          {(activeType === 'rent' || activeType === 'fee') && (
            <div>
              {months.map(m => {
                const ym = `${year}-${m}`;
                const paid = isPaid(ym, activeType);
                const amount = getAmount(ym, activeType);
                return (
                  <div key={m} style={{ display: 'grid', gridTemplateColumns: '35px 1fr 75px', gap: '6px', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid #f5f5f5' }}>
                    <div style={{ fontSize: '13px', fontWeight: 'bold', color: '#2c3e50' }}>{parseInt(m)}ì›”</div>
                    <div>
                      {paid ? (
                        <div style={{ fontSize: '12px', color: '#2c3e50', fontWeight: 'bold' }}>{fNum(amount)}</div>
                      ) : (
                        <input type="number" value={amount} onChange={e => setAmount(ym, activeType, e.target.value)}
                          style={{ width: '100%', padding: '5px', border: '2px solid #3498db', borderRadius: '5px', fontSize: '12px', fontWeight: 'bold', color: '#2c3e50' }} />
                      )}
                    </div>
                    <div>
                      {paid ? (
                        <>
                          <div className="pay-btn-paid">âœ…ì™„ë£Œ</div>
                          <button className="pay-btn-cancel" onClick={() => handleCancel(ym, activeType)}>ì·¨ì†Œ</button>
                        </>
                      ) : (
                        <button className="pay-btn-unpaid" onClick={() => handlePay(ym, activeType)} disabled={saving}>ğŸ’°ìˆ˜ë‚©</button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {activeType === 'other' && (
            <div>
              {months.map(m => {
                const ym = `${year}-${m}`;
                const others = getPays(ym, 'other');
                return (
                  <div key={m} style={{ padding: '8px 0', borderBottom: '1px solid #f5f5f5' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: others.length > 0 ? '5px' : '0' }}>
                      <span style={{ fontSize: '13px', fontWeight: 'bold', color: '#2c3e50' }}>{parseInt(m)}ì›”</span>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '5px' }}>
                        {others.length > 0 && <span style={{ fontSize: '11px', color: '#9b59b6', fontWeight: 'bold' }}>{fMan(others.reduce((s, p) => s + p.amount, 0))}</span>}
                        <button onClick={() => { setOtherModal(ym); setOtherForm({ amount: '', note: '' }); }}
                          style={{ background: '#9b59b6', color: 'white', border: 'none', borderRadius: '5px', padding: '4px 8px', cursor: 'pointer', fontSize: '11px', fontWeight: 'bold' }}>+</button>
                      </div>
                    </div>
                    {others.map(p => (
                      <div key={p.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#f5f0ff', borderRadius: '5px', padding: '5px 8px', marginBottom: '3px' }}>
                        <div style={{ flex: 1, minWidth: 0, marginRight: '6px' }}>
                          <div style={{ fontSize: '12px', fontWeight: 'bold', color: '#9b59b6' }}>{fNum(p.amount)}</div>
                          <div style={{ fontSize: '10px', color: '#7f8c8d', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{p.note}</div>
                        </div>
                        <button onClick={async () => { if (!confirm('ì‚­ì œ?')) return; await sb.from('payments').delete().eq('id', p.id); await onRefresh(); }}
                          style={{ background: '#e74c3c', color: 'white', border: 'none', borderRadius: '4px', padding: '3px 6px', cursor: 'pointer', fontSize: '10px', flexShrink: 0 }}>ì‚­ì œ</button>
                      </div>
                    ))}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      {otherModal && (
        <div onClick={e => { if (e.target === e.currentTarget) setOtherModal(null); }}
          style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 3000, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '14px' }}>
          <div style={{ background: 'white', borderRadius: '12px', padding: '18px', width: '100%', maxWidth: '320px' }}>
            <h3 style={{ fontSize: '15px', color: '#2c3e50', marginBottom: '12px' }}>ğŸ’œ ê¸°íƒ€ ìˆ˜ë‚© - {otherModal}</h3>
            <label style={{ display: 'block', fontSize: '11px', fontWeight: 'bold', color: '#2c3e50', marginBottom: '3px' }}>ê¸ˆì•¡ (ì›)</label>
            <input type="number" value={otherForm.amount} onChange={e => setOtherForm({ ...otherForm, amount: e.target.value })} placeholder="50000"
              style={{ width: '100%', padding: '8px', border: '2px solid #9b59b6', borderRadius: '5px', fontSize: '13px', marginBottom: '8px' }} />
            <label style={{ display: 'block', fontSize: '11px', fontWeight: 'bold', color: '#2c3e50', marginBottom: '3px' }}>ë©”ëª¨</label>
            <input value={otherForm.note} onChange={e => setOtherForm({ ...otherForm, note: e.target.value })} placeholder="ì£¼ì°¨ë¹„..."
              style={{ width: '100%', padding: '8px', border: '2px solid #ecf0f1', borderRadius: '5px', fontSize: '13px', marginBottom: '12px' }} />
            <div style={{ display: 'flex', gap: '6px' }}>
              <button onClick={() => setOtherModal(null)} className="btn" style={{ flex: 1, padding: '10px', background: '#95a5a6', color: 'white' }}>ì·¨ì†Œ</button>
              <button onClick={handleOtherSave} disabled={saving} className="btn" style={{ flex: 1, padding: '10px', background: '#9b59b6', color: 'white' }}>ì €ì¥</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default function App() {
  const [admin, setAdmin] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [tenants, setTenants] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [loans, setLoans] = useState([]);
  const [admins, setAdmins] = useState([]);
  const [expenseCategories, setExpenseCategories] = useState([]);
  const [payments, setPayments] = useState([]);
  const [loanPayments, setLoanPayments] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('');
  const [editItem, setEditItem] = useState(null);
  const [formData, setFormData] = useState({});
  const [selectedMonth, setSelectedMonth] = useState(thisMonth());
  const [tenantSort, setTenantSort] = useState('room');
  const [payTenant, setPayTenant] = useState(null);
  const [detailLoan, setDetailLoan] = useState(null);
  const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth <= 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => { if (admin) loadData(); }, [admin]);

  useEffect(() => {
    document.title = 'EPIDENCE ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤ | ì„ëŒ€ê´€ë¦¬ì‹œìŠ¤í…œ';
    
    let link = document.querySelector("link[rel~='icon']");
    if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
    link.href = LOGO_BASE64;
    
    let appleLink = document.querySelector("link[rel~='apple-touch-icon']");
    if (!appleLink) { appleLink = document.createElement('link'); appleLink.rel = 'apple-touch-icon'; document.head.appendChild(appleLink); }
    appleLink.href = LOGO_BASE64;
    
    let metaTheme = document.querySelector("meta[name='theme-color']");
    if (!metaTheme) { metaTheme = document.createElement('meta'); metaTheme.name = 'theme-color'; document.head.appendChild(metaTheme); }
    metaTheme.content = '#2c3e50';
  }, []);

  const loadData = async () => {
    setLoading(true);
    try {
      const [t, e, l, ec, a, p, lp] = await Promise.all([
        sb.from('tenants').select('*').order('room'),
        sb.from('expenses').select('*').order('date', { ascending: false }),
        sb.from('loans').select('*').order('lender_name'),
        sb.from('expense_categories').select('*').order('name'),
        sb.from('admins').select('id,name,role,active').order('name'),
        sb.from('payments').select('*').order('paid_at', { ascending: false }),
        sb.from('loan_payments').select('*').order('payment_date', { ascending: false })
      ]);
      setTenants(t.data || []); setExpenses(e.data || []);
      setLoans(l.data || []); setExpenseCategories(ec.data || []);
      setAdmins(a.data || []); setPayments(p.data || []);
      setLoanPayments(lp.data || []);
    } catch (err) { console.error(err); }
    finally { setLoading(false); }
  };

  const loadPayments = async () => {
    const { data } = await sb.from('payments').select('*').order('paid_at', { ascending: false });
    setPayments(data || []);
  };

  const openModal = (type, item = null) => {
    setModalType(type); setEditItem(item);
    const d = {
      tenant: { name: '', room: '', contact: '', deposit: 0, monthly_rent: 0, maintenance_fee: 0, payment_day: 5, move_in_date: '', contract_end: '' },
      expense: { date: new Date().toISOString().split('T')[0], category_name: '', amount: 0, description: '' },
      loan: { lender_name: '', remaining_amount: 0, initial_amount: 0, final_rate: 0, start_date: '', loan_type: 'bank', note: '' },
      admin: { name: '', passcode: '', role: 'admin', active: true }
    };
    setFormData(item ? { ...item } : d[type]);
    setShowModal(true);
  };

  const saveData = async e => {
    e.preventDefault();
    const tables = { tenant: 'tenants', expense: 'expenses', loan: 'loans', admin: 'admins' };
    try {
      let dataToSave = { ...formData };
      if (modalType === 'loan' && !editItem) {
        dataToSave.initial_amount = dataToSave.remaining_amount;
      }
      if (editItem) { await sb.from(tables[modalType]).update(dataToSave).eq('id', editItem.id); }
      else { await sb.from(tables[modalType]).insert([dataToSave]); }
      await loadData(); setShowModal(false); setFormData({}); setEditItem(null);
    } catch (err) { alert('ì‹¤íŒ¨: ' + err.message); }
  };

  const deleteItem = async (table, id) => {
    if (!window.confirm('ì‚­ì œ?')) return;
    await sb.from(table).delete().eq('id', id);
    await loadData();
  };

  const exportToExcel = () => {
    const year = new Date(selectedMonth).getFullYear();
    const workbook = XLSX.utils.book_new();

    // 1. ì„ì°¨ì¸ ì‹œíŠ¸
    const tenantsData = tenants.map(t => ({
      'í˜¸ìˆ˜': t.room,
      'ì´ë¦„': t.name,
      'ì—°ë½ì²˜': t.contact,
      'ë³´ì¦ê¸ˆ': t.deposit,
      'ì›”ì„¸': t.monthly_rent,
      'ê´€ë¦¬ë¹„': t.maintenance_fee,
      'ë‚©ì…ì¼': t.payment_day,
      'ì…ì£¼ì¼': t.move_in_date,
      'ê³„ì•½ë§Œë£Œì¼': t.contract_end
    }));
    const tenantsSheet = XLSX.utils.json_to_sheet(tenantsData);
    XLSX.utils.book_append_sheet(workbook, tenantsSheet, 'ì„ì°¨ì¸');

    // 2. ìˆ˜ë‚©ë‚´ì—­ ì‹œíŠ¸ (ì›”ë³„)
    const paymentsData = [];
    for (let i = 1; i <= 12; i++) {
      const month = String(i).padStart(2, '0');
      const ym = `${year}-${month}`;
      const monthPays = payments.filter(p => p.year_month === ym);
      monthPays.forEach(p => {
        const tenant = tenants.find(t => t.id === p.tenant_id);
        paymentsData.push({
          'ì›”': `${i}ì›”`,
          'í˜¸ìˆ˜': tenant?.room || '',
          'ì´ë¦„': tenant?.name || '',
          'ìœ í˜•': p.type === 'rent' ? 'ì›”ì„¸' : p.type === 'fee' ? 'ê´€ë¦¬ë¹„' : 'ê¸°íƒ€',
          'ê¸ˆì•¡': p.amount,
          'ë©”ëª¨': p.note || '',
          'ìˆ˜ë‚©ì¼': p.paid_at?.split('T')[0] || ''
        });
      });
    }
    const paymentsSheet = XLSX.utils.json_to_sheet(paymentsData);
    XLSX.utils.book_append_sheet(workbook, paymentsSheet, 'ìˆ˜ë‚©ë‚´ì—­');

    // 3. ì§€ì¶œë‚´ì—­ ì‹œíŠ¸ (ì›”ë³„)
    const expensesData = expenses
      .filter(e => e.date?.startsWith(year.toString()))
      .map(e => ({
        'ì›”': `${new Date(e.date).getMonth() + 1}ì›”`,
        'ë‚ ì§œ': e.date,
        'ì¹´í…Œê³ ë¦¬': e.category_name,
        'ê¸ˆì•¡': e.amount,
        'ì„¤ëª…': e.description || ''
      }));
    const expensesSheet = XLSX.utils.json_to_sheet(expensesData);
    XLSX.utils.book_append_sheet(workbook, expensesSheet, 'ì§€ì¶œë‚´ì—­');

    // 4. ëŒ€ì¶œë‚´ì—­ ì‹œíŠ¸
    const loansData = loans.map(l => {
      const lp = loanPayments.filter(p => p.loan_id === l.id);
      const totalPaid = lp.reduce((s, p) => s + (p.amount || 0), 0);
      const currentBalance = (l.initial_amount || l.remaining_amount || 0) - totalPaid;
      return {
        'ëŒ€ì¶œì²˜': l.lender_name,
        'ì´ˆê¸°ê¸ˆì•¡': l.initial_amount || l.remaining_amount,
        'ìƒí™˜ì•¡': totalPaid,
        'í˜„ì¬ì”ì•¡': currentBalance,
        'ê¸ˆë¦¬': `${((l.final_rate || 0) * 100).toFixed(2)}%`,
        'ì—°ì´ì': Math.round(currentBalance * (l.final_rate || 0)),
        'ì›”ì´ì': Math.round((currentBalance * (l.final_rate || 0)) / 12)
      };
    });
    const loansSheet = XLSX.utils.json_to_sheet(loansData);
    XLSX.utils.book_append_sheet(workbook, loansSheet, 'ëŒ€ì¶œë‚´ì—­');

    // 5. ëŒ€ì¶œ ìƒí™˜ë‚´ì—­ ì‹œíŠ¸
    const loanPaymentsData = loanPayments
      .filter(lp => {
        const loan = loans.find(l => l.id === lp.loan_id);
        return loan && lp.payment_date?.startsWith(year.toString());
      })
      .map(lp => {
        const loan = loans.find(l => l.id === lp.loan_id);
        return {
          'ì›”': `${new Date(lp.payment_date).getMonth() + 1}ì›”`,
          'ëŒ€ì¶œì²˜': loan?.lender_name || '',
          'ìƒí™˜ì¼': lp.payment_date,
          'ìƒí™˜ì•¡': lp.amount,
          'ë©”ëª¨': lp.note || ''
        };
      });
    const loanPaymentsSheet = XLSX.utils.json_to_sheet(loanPaymentsData);
    XLSX.utils.book_append_sheet(workbook, loanPaymentsSheet, 'ëŒ€ì¶œìƒí™˜ë‚´ì—­');

    // 6. ì›”ë³„ìš”ì•½ ì‹œíŠ¸
    const summaryData = [];
    let yearRevenue = 0, yearExpense = 0;
    for (let i = 1; i <= 12; i++) {
      const month = String(i).padStart(2, '0');
      const ym = `${year}-${month}`;
      const monthPays = payments.filter(p => p.year_month === ym);
      const monthExp = expenses.filter(e => e.date?.startsWith(ym));
      const revenue = monthPays.reduce((s, p) => s + (p.amount || 0), 0);
      const expense = monthExp.reduce((s, e) => s + (e.amount || 0), 0);
      const netProfit = revenue - expense;
      yearRevenue += revenue;
      yearExpense += expense;
      summaryData.push({
        'ì›”': `${i}ì›”`,
        'ìˆ˜ìµ': revenue,
        'ì§€ì¶œ': expense,
        'ìˆœìµ': netProfit,
        'ì›”ì„¸ìˆ˜ë‚©': monthPays.filter(p => p.type === 'rent').reduce((s, p) => s + p.amount, 0),
        'ê´€ë¦¬ë¹„ìˆ˜ë‚©': monthPays.filter(p => p.type === 'fee').reduce((s, p) => s + p.amount, 0),
        'ê¸°íƒ€ìˆ˜ë‚©': monthPays.filter(p => p.type === 'other').reduce((s, p) => s + p.amount, 0)
      });
    }
    summaryData.push({
      'ì›”': 'í•©ê³„',
      'ìˆ˜ìµ': yearRevenue,
      'ì§€ì¶œ': yearExpense,
      'ìˆœìµ': yearRevenue - yearExpense,
      'ì›”ì„¸ìˆ˜ë‚©': summaryData.reduce((s, d) => s + (d['ì›”ì„¸ìˆ˜ë‚©'] || 0), 0),
      'ê´€ë¦¬ë¹„ìˆ˜ë‚©': summaryData.reduce((s, d) => s + (d['ê´€ë¦¬ë¹„ìˆ˜ë‚©'] || 0), 0),
      'ê¸°íƒ€ìˆ˜ë‚©': summaryData.reduce((s, d) => s + (d['ê¸°íƒ€ìˆ˜ë‚©'] || 0), 0)
    });
    const summarySheet = XLSX.utils.json_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(workbook, summarySheet, 'ì›”ë³„ìš”ì•½');

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    XLSX.writeFile(workbook, `ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤_${year}ë…„_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  if (!admin) return (
    <>
      <style>{css}</style>
      <LoginScreen onLogin={setAdmin} />
    </>
  );

  const curExp = expenses.filter(e => e.date?.startsWith(selectedMonth));
  const totalExp = curExp.reduce((s, e) => s + (e.amount || 0), 0);
  const curPays = payments.filter(p => p.year_month === selectedMonth);
  const totalRev = curPays.reduce((s, p) => s + (p.amount || 0), 0);
  const totalLoan = loans.reduce((s, l) => {
    const lp = loanPayments.filter(p => p.loan_id === l.id);
    const totalPaid = lp.reduce((sum, p) => sum + (p.amount || 0), 0);
    const currentBalance = (l.initial_amount || l.remaining_amount || 0) - totalPaid;
    return s + currentBalance;
  }, 0);
  const totalMInt = loans.reduce((s, l) => {
    const lp = loanPayments.filter(p => p.loan_id === l.id);
    const totalPaid = lp.reduce((sum, p) => sum + (p.amount || 0), 0);
    const currentBalance = (l.initial_amount || l.remaining_amount || 0) - totalPaid;
    return s + ((currentBalance * l.final_rate) / 12);
  }, 0);
  const profit = totalRev - totalExp;
  const byCat = curExp.reduce((acc, e) => { acc[e.category_name || 'ê¸°íƒ€'] = (acc[e.category_name || 'ê¸°íƒ€'] || 0) + e.amount; return acc; }, {});
  const totalDep = tenants.reduce((s, t) => s + (t.deposit || 0), 0);
  const totalRent = tenants.reduce((s, t) => s + (t.monthly_rent || 0), 0);
  const totalFee = tenants.reduce((s, t) => s + (t.maintenance_fee || 0), 0);
  const sortedTenants = [...tenants].sort((a, b) => tenantSort === 'room' ? (a.room || '').localeCompare(b.room || '', 'ko') : (a.payment_day || 0) - (b.payment_day || 0));
  const unpaidRent = tenants.filter(t => !payments.some(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'rent'));
  const unpaidFee = tenants.filter(t => !payments.some(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'fee'));

  const tabs = [
    { id: 'dashboard', icon: 'ğŸ“Š', label: 'ëŒ€ì‹œë³´ë“œ' },
    { id: 'tenants', icon: 'ğŸ‘¥', label: 'ì„ì°¨ì¸' },
    { id: 'expenses', icon: 'ğŸ’¸', label: 'ì§€ì¶œ' },
    { id: 'loans', icon: 'ğŸ¦', label: 'ëŒ€ì¶œ' },
    { id: 'admins', icon: 'âš™ï¸', label: 'ê´€ë¦¬ì' }
  ];

  const inp = { width: '100%', padding: '10px', border: '2px solid #ecf0f1', borderRadius: '6px', fontSize: '14px', marginBottom: '10px' };
  const lbl = { display: 'block', marginBottom: '4px', fontSize: '12px', fontWeight: 'bold', color: '#2c3e50' };

  return (
    <>
      <style>{css}</style>
      <div style={{ display: 'flex', minHeight: '100vh' }}>

        {/* PC ì‚¬ì´ë“œë°” */}
        <div id="sidebar" style={{ width: '220px', background: '#2c3e50', color: 'white', padding: '18px', position: 'fixed', height: '100vh', overflowY: 'auto', zIndex: 100 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' }}>
            <div style={{ width: '45px', height: '45px', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, background: 'white', borderRadius: '8px', padding: '4px' }}>
              <img src={LOGO_BASE64} alt="EPIDENCE" style={{ 
                width: '100%', 
                height: '100%', 
                objectFit: 'contain'
              }} />
            </div>
            <div>
              <div style={{ fontSize: '15px', fontWeight: 'bold', letterSpacing: '1px' }}>EPIDENCE</div>
              <div style={{ fontSize: '10px', color: '#95a5a6' }}>ì˜¬ì¸ìŠ¤í˜ì´ìŠ¤</div>
            </div>
          </div>
          <div style={{ fontSize: '11px', color: '#7f8c8d', marginBottom: '14px' }}>ğŸ‘¤ {admin.name}</div>
          <hr style={{ borderColor: '#34495e', marginBottom: '12px' }} />
          {tabs.map(({ id, icon, label }) => (
            <button key={id} onClick={() => setActiveTab(id)}
              style={{ display: 'flex', alignItems: 'center', gap: '8px', width: '100%', padding: '10px 12px', marginBottom: '5px', background: activeTab === id ? '#3498db' : 'transparent', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', textAlign: 'left' }}>
              <span>{icon}</span><span>{label}</span>
            </button>
          ))}
          <div style={{ marginTop: '16px', padding: '8px', background: '#27ae60', borderRadius: '6px', fontSize: '11px', textAlign: 'center', marginBottom: '6px' }}>â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°</div>
          <button onClick={() => setAdmin(null)} style={{ width: '100%', padding: '8px', background: '#e74c3c', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: 'bold' }}>ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        {/* ë©”ì¸ ì»¨í…ì¸  */}
        <div id="main" style={{ flex: 1, marginLeft: '220px', padding: '24px' }}>
          {loading && <div style={{ textAlign: 'center', padding: '50px', color: '#7f8c8d' }}>ë¡œë”©ì¤‘...</div>}

          {/* ëŒ€ì‹œë³´ë“œ */}
          {!loading && activeTab === 'dashboard' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '14px', flexWrap: 'wrap', gap: '8px' }}>
                <h2 style={{ fontSize: '22px', color: '#2c3e50', fontWeight: 'bold' }}>ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                  <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} style={{ padding: '7px 12px', fontSize: '13px', borderRadius: '6px', border: '2px solid #3498db' }} />
                  <button onClick={exportToExcel} className="btn" style={{ padding: '9px 16px', background: '#27ae60', color: 'white', whiteSpace: 'nowrap' }}>ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                </div>
              </div>
              <div className="stat-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(5,1fr)', gap: '10px', marginBottom: '14px' }}>
                {[
                  { label: 'ì‹¤ìˆ˜ë‚©', val: fMan(totalRev), color: '#27ae60' },
                  { label: 'ì§€ì¶œ', val: fMan(totalExp), color: '#e74c3c' },
                  { label: 'ìˆœìµ', val: fMan(profit), color: profit >= 0 ? '#3498db' : '#e74c3c' },
                  { label: 'ëŒ€ì¶œ', val: fUk(totalLoan), color: '#c0392b' },
                  { label: 'ì›”ì´ì', val: fMan(totalMInt), color: '#e67e22' }
                ].map(({ label, val, color }) => (
                  <div key={label} className="card stat-card" style={{ padding: '14px', borderTop: `3px solid ${color}` }}>
                    <div className="stat-card-label" style={{ fontSize: '10px', color: '#7f8c8d', marginBottom: '4px' }}>{label}</div>
                    <div className="stat-card-value" style={{ fontSize: '16px', fontWeight: 'bold', color }}>{val}</div>
                  </div>
                ))}
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit,minmax(250px,1fr))', gap: '10px', marginBottom: '12px' }}>
                {[{ title: 'âš ï¸ ì›”ì„¸ ë¯¸ë‚©', list: unpaidRent, key: 'monthly_rent', color: '#e74c3c' }, { title: 'âš ï¸ ê´€ë¦¬ë¹„ ë¯¸ë‚©', list: unpaidFee, key: 'maintenance_fee', color: '#e67e22' }].map(({ title, list, key, color }) => (
                  <div key={title} className="card" style={{ padding: '14px', borderLeft: `4px solid ${color}` }}>
                    <div style={{ fontSize: '13px', fontWeight: 'bold', color, marginBottom: '8px' }}>{title} ({list.length})</div>
                    {list.length === 0 ? <p style={{ color: '#27ae60', fontSize: '12px' }}>âœ… ì „ì› ìˆ˜ë‚©ì™„ë£Œ!</p> :
                      list.slice(0, 3).map(t => (
                        <div key={t.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid #f5f5f5', fontSize: '12px' }}>
                          <span style={{ fontWeight: 'bold', color: '#3498db', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', marginRight: '8px' }}>{t.room} {t.name}</span>
                          <span style={{ color, flexShrink: 0 }}>{fMan(t[key])}</span>
                        </div>
                      ))}
                    {list.length > 3 && <div style={{ fontSize: '11px', color: '#95a5a6', marginTop: '4px' }}>ì™¸ {list.length - 3}ê±´</div>}
                  </div>
                ))}
              </div>
              <div className="card" style={{ padding: '14px' }}>
                <h3 style={{ fontSize: '14px', marginBottom: '10px', color: '#2c3e50' }}>ğŸ’¸ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h3>
                {Object.keys(byCat).length === 0 ? <p style={{ color: '#95a5a6', fontSize: '12px' }}>ì§€ì¶œ ì—†ìŒ</p> :
                  Object.entries(byCat).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([cat, amt]) => (
                    <div key={cat} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid #f5f5f5' }}>
                      <span style={{ fontSize: '12px', color: '#2c3e50' }}>{cat}</span>
                      <strong style={{ color: '#e74c3c', fontSize: '12px' }}>{fMan(amt)}</strong>
                    </div>
                  ))}
              </div>
              
              {/* ì›”ë³„ ì¶”ì„¸ */}
              <div className="card" style={{ padding: '14px', marginTop: '12px' }}>
                <h3 style={{ fontSize: '14px', marginBottom: '10px', color: '#2c3e50' }}>ğŸ“ˆ ì›”ë³„ ì¶”ì„¸ ({new Date(selectedMonth).getFullYear()}ë…„)</h3>
                <div style={{ overflowX: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '300px' }}>
                    <thead>
                      <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #ecf0f1' }}>
                        <th style={{ padding: '8px 4px', textAlign: 'left', fontSize: '11px', color: '#7f8c8d' }}>ì›”</th>
                        <th style={{ padding: '8px 4px', textAlign: 'right', fontSize: '11px', color: '#7f8c8d' }}>ìˆ˜ìµ</th>
                        <th style={{ padding: '8px 4px', textAlign: 'right', fontSize: '11px', color: '#7f8c8d' }}>ì§€ì¶œ</th>
                        <th style={{ padding: '8px 4px', textAlign: 'right', fontSize: '11px', color: '#7f8c8d' }}>ìˆœìµ</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Array.from({ length: 12 }, (_, i) => {
                        const month = String(i + 1).padStart(2, '0');
                        const ym = `${new Date(selectedMonth).getFullYear()}-${month}`;
                        const monthPays = payments.filter(p => p.year_month === ym);
                        const monthExp = expenses.filter(e => e.date?.startsWith(ym));
                        const revenue = monthPays.reduce((s, p) => s + (p.amount || 0), 0);
                        const expense = monthExp.reduce((s, e) => s + (e.amount || 0), 0);
                        const netProfit = revenue - expense;
                        const isCurrentMonth = ym === selectedMonth;
                        return (
                          <tr key={month} style={{ borderBottom: '1px solid #f5f5f5', background: isCurrentMonth ? '#e3f2fd' : 'white' }}>
                            <td style={{ padding: '8px 4px', fontSize: '12px', fontWeight: isCurrentMonth ? 'bold' : 'normal', color: isCurrentMonth ? '#2196f3' : '#2c3e50' }}>{parseInt(month)}ì›”</td>
                            <td style={{ padding: '8px 4px', textAlign: 'right', fontSize: '12px', color: '#27ae60', fontWeight: revenue > 0 ? 'bold' : 'normal' }}>{revenue > 0 ? fMan(revenue) : '-'}</td>
                            <td style={{ padding: '8px 4px', textAlign: 'right', fontSize: '12px', color: '#e74c3c', fontWeight: expense > 0 ? 'bold' : 'normal' }}>{expense > 0 ? fMan(expense) : '-'}</td>
                            <td style={{ padding: '8px 4px', textAlign: 'right', fontSize: '12px', fontWeight: 'bold', color: netProfit > 0 ? '#27ae60' : netProfit < 0 ? '#e74c3c' : '#95a5a6' }}>
                              {netProfit !== 0 ? fMan(netProfit) : '-'}
                            </td>
                          </tr>
                        );
                      })}
                      <tr style={{ background: '#f8f9fa', borderTop: '2px solid #ecf0f1', fontWeight: 'bold' }}>
                        <td style={{ padding: '10px 4px', fontSize: '12px', color: '#2c3e50' }}>í•©ê³„</td>
                        <td style={{ padding: '10px 4px', textAlign: 'right', fontSize: '13px', color: '#27ae60' }}>
                          {fMan(payments.filter(p => p.year_month?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, p) => s + (p.amount || 0), 0))}
                        </td>
                        <td style={{ padding: '10px 4px', textAlign: 'right', fontSize: '13px', color: '#e74c3c' }}>
                          {fMan(expenses.filter(e => e.date?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, e) => s + (e.amount || 0), 0))}
                        </td>
                        <td style={{ padding: '10px 4px', textAlign: 'right', fontSize: '13px', color: payments.filter(p => p.year_month?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, p) => s + (p.amount || 0), 0) - expenses.filter(e => e.date?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, e) => s + (e.amount || 0), 0) >= 0 ? '#27ae60' : '#e74c3c' }}>
                          {fMan(payments.filter(p => p.year_month?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, p) => s + (p.amount || 0), 0) - expenses.filter(e => e.date?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, e) => s + (e.amount || 0), 0))}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}


          {/* ì„ì°¨ì¸ íƒ­ */}
          {!loading && activeTab === 'tenants' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', flexWrap: 'wrap', gap: '8px' }}>
                <h2 style={{ fontSize: '22px', color: '#2c3e50', fontWeight: 'bold' }}>ğŸ‘¥ ì„ì°¨ì¸</h2>
                <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                  <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} style={{ padding: '7px 10px', fontSize: '12px', borderRadius: '6px', border: '2px solid #27ae60' }} />
                  <button className="btn" onClick={() => openModal('tenant')} style={{ padding: '9px 16px', background: '#27ae60', color: 'white' }}>+ ì¶”ê°€</button>
                </div>
              </div>
              
              {/* í•©ê³„ */}
              <div className="stat-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(6,1fr)', gap: '8px', marginBottom: '12px' }}>
                {[
                  { label: 'ì´ ì„ì°¨ì¸', val: `${tenants.length}ëª…`, color: '#3498db' },
                  { label: 'ì›” ì´ìˆ˜ì…', val: fMan(totalRent + totalFee + curPays.filter(p => p.type === 'other').reduce((s, p) => s + p.amount, 0)), color: '#e74c3c' },
                  { label: 'ë³´ì¦ê¸ˆ', val: fUk(totalDep), color: '#9b59b6' },
                  { label: 'ì›”ì„¸', val: fMan(totalRent), color: '#27ae60' },
                  { label: 'ê´€ë¦¬ë¹„', val: fMan(totalFee), color: '#e67e22' },
                  { label: 'ê¸°íƒ€', val: fMan(curPays.filter(p => p.type === 'other').reduce((s, p) => s + p.amount, 0)), color: '#9b59b6' }
                ].map(({ label, val, color }) => (
                  <div key={label} className="card stat-card" style={{ padding: '10px', borderLeft: `4px solid ${color}` }}>
                    <div className="stat-card-label" style={{ fontSize: '9px', color: '#7f8c8d', marginBottom: '3px' }}>{label}</div>
                    <div className="stat-card-value" style={{ fontSize: '14px', fontWeight: 'bold', color }}>{val}</div>
                  </div>
                ))}
              </div>

              {/* ì •ë ¬ */}
              <div style={{ display: 'flex', gap: '6px', marginBottom: '10px', alignItems: 'center', flexWrap: 'wrap' }}>
                <span style={{ fontSize: '12px', color: '#7f8c8d', fontWeight: 'bold' }}>ì •ë ¬:</span>
                {[{ k: 'room', l: 'ğŸ  í˜¸ìˆ˜ìˆœ' }, { k: 'payment_day', l: 'ğŸ“… ë‚©ì…ì¼ìˆœ' }].map(({ k, l }) => (
                  <button key={k} onClick={() => setTenantSort(k)} style={{ padding: '6px 12px', background: tenantSort === k ? '#2c3e50' : 'white', color: tenantSort === k ? 'white' : '#2c3e50', border: '2px solid #2c3e50', borderRadius: '6px', cursor: 'pointer', fontSize: '12px', fontWeight: 'bold', whiteSpace: 'nowrap' }}>{l}</button>
                ))}
              </div>

              {/* ë°ìŠ¤í¬í†± í…Œì´ë¸” */}
              {!isMobile && (
                <div className="card" style={{ overflow: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '750px' }}>
                    <thead style={{ background: '#34495e', color: 'white' }}>
                      <tr>{['ê´€ë¦¬', 'í˜¸ìˆ˜', 'ì´ë¦„', 'ì—°ë½ì²˜', 'ë³´ì¦ê¸ˆ', 'ì›”ì„¸', 'ê´€ë¦¬ë¹„', 'ë‚©ì…ì¼', `${selectedMonth} ìˆ˜ë‚©`].map(h => <th key={h} style={{ padding: '12px 10px', textAlign: 'left', fontSize: '12px' }}>{h}</th>)}</tr>
                    </thead>
                    <tbody>
                    {sortedTenants.map((t, i) => {
                      const rp = payments.some(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'rent');
                      const fp = payments.some(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'fee');
                      const otherPays = payments.filter(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'other');
                      const otherTotal = otherPays.reduce((s, p) => s + p.amount, 0);
                      return (
                        <tr key={t.id} style={{ borderBottom: '1px solid #f0f0f0', background: i % 2 === 0 ? 'white' : '#fafafa' }}>
                          <td style={{ padding: '11px 10px' }}>
                            <div style={{ display: 'flex', gap: '3px' }}>
                              <button className="btn" onClick={() => setPayTenant(t)} style={{ padding: '6px 10px', background: '#27ae60', color: 'white', fontWeight: 'bold' }}>ğŸ’° ìˆ˜ë‚©</button>
                              <button className="btn" onClick={() => openModal('tenant', t)} style={{ padding: '6px 10px', background: '#3498db', color: 'white' }}>ìˆ˜ì •</button>
                            </div>
                          </td>
                          <td style={{ padding: '11px 10px', fontWeight: 'bold', color: '#3498db' }}>{t.room}</td>
                          <td style={{ padding: '11px 10px' }}>{t.name}</td>
                          <td style={{ padding: '11px 10px', fontSize: '12px' }}>
                            {t.contact && t.contact !== 'ë¯¸ë“±ë¡' ? (
                              <a href={`tel:${t.contact}`} style={{ color: '#3498db', textDecoration: 'none', fontWeight: 'bold' }}>
                                ğŸ“ {t.contact}
                              </a>
                            ) : (
                              <span style={{ color: '#95a5a6' }}>{t.contact || 'ë¯¸ë“±ë¡'}</span>
                            )}
                          </td>
                          <td style={{ padding: '11px 10px', fontSize: '12px' }}>{fMan(t.deposit)}</td>
                          <td style={{ padding: '11px 10px', fontSize: '12px' }}>{fMan(t.monthly_rent)}</td>
                          <td style={{ padding: '11px 10px', fontSize: '12px' }}>{fMan(t.maintenance_fee)}</td>
                          <td style={{ padding: '11px 10px' }}><span style={{ background: '#eaf4ff', color: '#3498db', padding: '2px 7px', borderRadius: '12px', fontSize: '11px', fontWeight: 'bold' }}>ë§¤ì›” {t.payment_day}ì¼</span></td>
                          <td style={{ padding: '11px 10px' }}>
                            {(() => {
                              const allPaid = rp && fp;
                              const noPaid = !rp && !fp;
                              if (allPaid) {
                                return (
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <span style={{ background: '#d5f5e3', color: '#27ae60', padding: '4px 10px', borderRadius: '6px', fontSize: '12px', fontWeight: 'bold' }}>âœ… ìˆ˜ë‚©ì™„ë£Œ</span>
                                    {otherTotal > 0 && <span style={{ background: '#f5f0ff', color: '#9b59b6', padding: '2px 6px', borderRadius: '5px', fontSize: '10px', fontWeight: 'bold' }}>ğŸ’œ{fMan(otherTotal)}</span>}
                                  </div>
                                );
                              }
                              return (
                                <div style={{ display: 'flex', gap: '3px', flexWrap: 'wrap' }}>
                                  <span style={{ background: rp ? '#d5f5e3' : '#fdeaea', color: rp ? '#27ae60' : '#e74c3c', padding: '2px 6px', borderRadius: '5px', fontSize: '10px', fontWeight: 'bold' }}>{rp ? 'âœ…ì›”ì„¸' : 'âŒì›”ì„¸'}</span>
                                  <span style={{ background: fp ? '#d5f5e3' : '#fef3e2', color: fp ? '#27ae60' : '#e67e22', padding: '2px 6px', borderRadius: '5px', fontSize: '10px', fontWeight: 'bold' }}>{fp ? 'âœ…ê´€ë¦¬ë¹„' : 'âŒê´€ë¦¬ë¹„'}</span>
                                  {otherTotal > 0 && <span style={{ background: '#f5f0ff', color: '#9b59b6', padding: '2px 6px', borderRadius: '5px', fontSize: '10px', fontWeight: 'bold' }}>ğŸ’œ{fMan(otherTotal)}</span>}
                                </div>
                              );
                            })()}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              )}

              {/* ëª¨ë°”ì¼ ì¹´ë“œ */}
              {isMobile && (
                <div>
                {sortedTenants.length === 0 ? (
                  <div className="card" style={{ padding: '40px', textAlign: 'center', color: '#95a5a6' }}>
                    <div style={{ fontSize: '40px', marginBottom: '10px' }}>ğŸ“</div>
                    <p style={{ fontSize: '14px' }}>ë“±ë¡ëœ ì„ì°¨ì¸ ì—†ìŒ</p>
                  </div>
                ) : sortedTenants.map(t => {
                  const rp = payments.some(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'rent');
                  const fp = payments.some(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'fee');
                  const otherPays = payments.filter(p => p.tenant_id === t.id && p.year_month === selectedMonth && p.type === 'other');
                  const otherTotal = otherPays.reduce((s, p) => s + p.amount, 0);
                  const allPaid = rp && fp;
                  const borderColor = allPaid ? '#27ae60' : '#e74c3c';
                  return (
                    <div key={t.id} style={{ background: 'white', borderRadius: '10px', padding: '12px', marginBottom: '8px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', borderLeft: `4px solid ${borderColor}` }}>
                      {/* í˜¸ìˆ˜ì™€ ì´ë¦„ + ìˆ˜ë‚© ë²„íŠ¼ */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px', gap: '8px' }}>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <div style={{ fontSize: '15px', fontWeight: 'bold', color: '#3498db' }}>ğŸ  {t.room} {t.name}</div>
                        </div>
                        <button onClick={() => setPayTenant(t)} style={{ padding: '6px 12px', background: '#27ae60', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '13px', fontWeight: 'bold', whiteSpace: 'nowrap', flexShrink: 0 }}>ğŸ’° ìˆ˜ë‚©</button>
                      </div>
                      
                      {/* ì—°ë½ì²˜ */}
                      <div style={{ fontSize: '12px', marginBottom: '8px' }}>
                        {t.contact && t.contact !== 'ë¯¸ë“±ë¡' ? (
                          <a href={`tel:${t.contact}`} style={{ color: '#27ae60', textDecoration: 'none', fontWeight: 'bold', display: 'inline-flex', alignItems: 'center', gap: '4px', padding: '4px 8px', background: '#e8f8f5', borderRadius: '6px' }}>
                            ğŸ“ {t.contact}
                          </a>
                        ) : (
                          <span style={{ color: '#95a5a6', fontSize: '11px' }}>ğŸ“ {t.contact || 'ë¯¸ë“±ë¡'}</span>
                        )}
                      </div>
                      
                      {/* ê¸ˆì•¡ ì •ë³´ - í•œ ì¤„ë¡œ */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '8px', flexWrap: 'wrap', gap: '4px' }}>
                        <span style={{ color: '#7f8c8d' }}>ë³´ì¦ê¸ˆ <strong style={{ color: '#9b59b6' }}>{fMan(t.deposit)}</strong></span>
                        <span style={{ color: '#7f8c8d' }}>ì›”ì„¸ <strong style={{ color: '#27ae60' }}>{fMan(t.monthly_rent)}</strong></span>
                        <span style={{ color: '#7f8c8d' }}>ê´€ë¦¬ë¹„ <strong style={{ color: '#e67e22' }}>{fMan(t.maintenance_fee)}</strong></span>
                      </div>
                      
                      {/* ë‚©ì…ì¼ */}
                      <div style={{ fontSize: '11px', color: '#7f8c8d', marginBottom: '8px' }}>
                        ë‚©ì…ì¼: <span style={{ background: '#eaf4ff', color: '#3498db', padding: '2px 6px', borderRadius: '8px', fontWeight: 'bold' }}>ë§¤ì›” {t.payment_day}ì¼</span>
                      </div>
                      
                      {/* ìˆ˜ë‚© ìƒíƒœ */}
                      <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap', alignItems: 'center' }}>
                        {(() => {
                          const allPaid = rp && fp;
                          if (allPaid) {
                            return (
                              <>
                                <span style={{ background: '#d5f5e3', color: '#27ae60', padding: '5px 12px', borderRadius: '8px', fontSize: '13px', fontWeight: 'bold', whiteSpace: 'nowrap' }}>âœ… ìˆ˜ë‚©ì™„ë£Œ</span>
                                {otherTotal > 0 && <span style={{ background: '#f5f0ff', color: '#9b59b6', padding: '3px 8px', borderRadius: '8px', fontSize: '11px', fontWeight: 'bold', whiteSpace: 'nowrap' }}>ğŸ’œê¸°íƒ€ {fMan(otherTotal)}</span>}
                              </>
                            );
                          }
                          return (
                            <>
                              <span style={{ background: rp ? '#d5f5e3' : '#fdeaea', color: rp ? '#27ae60' : '#e74c3c', padding: '3px 8px', borderRadius: '8px', fontSize: '11px', fontWeight: 'bold', whiteSpace: 'nowrap' }}>{rp ? 'âœ…ì›”ì„¸' : 'âŒì›”ì„¸'}</span>
                              <span style={{ background: fp ? '#d5f5e3' : '#fef3e2', color: fp ? '#27ae60' : '#e67e22', padding: '3px 8px', borderRadius: '8px', fontSize: '11px', fontWeight: 'bold', whiteSpace: 'nowrap' }}>{fp ? 'âœ…ê´€ë¦¬ë¹„' : 'âŒê´€ë¦¬ë¹„'}</span>
                              {otherTotal > 0 && <span style={{ background: '#f5f0ff', color: '#9b59b6', padding: '3px 8px', borderRadius: '8px', fontSize: '11px', fontWeight: 'bold', whiteSpace: 'nowrap' }}>ğŸ’œê¸°íƒ€ {fMan(otherTotal)}</span>}
                            </>
                          );
                        })()}
                        <button onClick={() => openModal('tenant', t)} style={{ marginLeft: 'auto', padding: '3px 8px', background: '#3498db', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '10px', fontWeight: 'bold' }}>âœï¸ ìˆ˜ì •</button>
                      </div>
                    </div>
                  );
                })}
              </div>
              )}
            </div>
          )}


          {/* ì§€ì¶œ íƒ­ - ê°„ëµí™” */}
          {!loading && activeTab === 'expenses' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', flexWrap: 'wrap', gap: '6px' }}>
                <h2 style={{ fontSize: '22px', color: '#2c3e50', fontWeight: 'bold' }}>ğŸ’¸ ì§€ì¶œ</h2>
                <div style={{ display: 'flex', gap: '6px' }}>
                  <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} style={{ padding: '7px 10px', fontSize: '12px', borderRadius: '6px', border: '2px solid #e74c3c' }} />
                  <button className="btn" onClick={() => openModal('expense')} style={{ padding: '9px 16px', background: '#e74c3c', color: 'white' }}>+ ì¶”ê°€</button>
                </div>
              </div>
              <div className="card" style={{ padding: '16px', marginBottom: '12px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                <div><div style={{ fontSize: '11px', color: '#7f8c8d' }}>ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ</div><div style={{ fontSize: '26px', fontWeight: 'bold', color: '#e74c3c' }}>{fMan(totalExp)}</div></div>
                <div style={{ fontSize: '36px' }}>ğŸ’¸</div>
              </div>
              <div className="card" style={{ padding: '12px' }}>
                {curExp.length === 0 ? <p style={{ textAlign: 'center', color: '#95a5a6', padding: '20px', fontSize: '13px' }}>ì§€ì¶œ ë‚´ì—­ ì—†ìŒ</p> :
                  curExp.slice(0, 20).map((exp, i) => (
                    <div key={exp.id} style={{ padding: '10px 0', borderBottom: i < curExp.length - 1 ? '1px solid #f5f5f5' : 'none', display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '8px' }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontSize: '12px', color: '#2c3e50', fontWeight: 'bold', marginBottom: '2px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{exp.date} Â· {exp.category_name}</div>
                        <div style={{ fontSize: '11px', color: '#7f8c8d', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{exp.description}</div>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px', flexShrink: 0 }}>
                        <div style={{ fontSize: '13px', fontWeight: 'bold', color: '#e74c3c', whiteSpace: 'nowrap' }}>{fMan(exp.amount)}</div>
                        <button className="btn" onClick={() => deleteItem('expenses', exp.id)} style={{ padding: '4px 6px', background: '#e74c3c', color: 'white' }}>ì‚­ì œ</button>
                      </div>
                    </div>
                  ))}
              </div>
              
              {/* ì›”ë³„ ì§€ì¶œ ì¶”ì„¸ */}
              <div className="card" style={{ padding: '14px', marginTop: '12px' }}>
                <h3 style={{ fontSize: '14px', marginBottom: '10px', color: '#2c3e50' }}>ğŸ“Š ì›”ë³„ ì§€ì¶œ/ìˆ˜ìµ ì¶”ì„¸ ({new Date(selectedMonth).getFullYear()}ë…„)</h3>
                <div style={{ overflowX: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: '300px' }}>
                    <thead>
                      <tr style={{ background: '#f8f9fa', borderBottom: '2px solid #ecf0f1' }}>
                        <th style={{ padding: '8px 4px', textAlign: 'left', fontSize: '11px', color: '#7f8c8d' }}>ì›”</th>
                        <th style={{ padding: '8px 4px', textAlign: 'right', fontSize: '11px', color: '#7f8c8d' }}>ìˆ˜ìµ</th>
                        <th style={{ padding: '8px 4px', textAlign: 'right', fontSize: '11px', color: '#7f8c8d' }}>ì§€ì¶œ</th>
                        <th style={{ padding: '8px 4px', textAlign: 'right', fontSize: '11px', color: '#7f8c8d' }}>ìˆœìµ</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Array.from({ length: 12 }, (_, i) => {
                        const month = String(i + 1).padStart(2, '0');
                        const ym = `${new Date(selectedMonth).getFullYear()}-${month}`;
                        const monthPays = payments.filter(p => p.year_month === ym);
                        const monthExp = expenses.filter(e => e.date?.startsWith(ym));
                        const revenue = monthPays.reduce((s, p) => s + (p.amount || 0), 0);
                        const expense = monthExp.reduce((s, e) => s + (e.amount || 0), 0);
                        const netProfit = revenue - expense;
                        const isCurrentMonth = ym === selectedMonth;
                        return (
                          <tr key={month} style={{ borderBottom: '1px solid #f5f5f5', background: isCurrentMonth ? '#fef3e2' : 'white' }}>
                            <td style={{ padding: '8px 4px', fontSize: '12px', fontWeight: isCurrentMonth ? 'bold' : 'normal', color: isCurrentMonth ? '#e67e22' : '#2c3e50' }}>{parseInt(month)}ì›”</td>
                            <td style={{ padding: '8px 4px', textAlign: 'right', fontSize: '12px', color: '#27ae60', fontWeight: revenue > 0 ? 'bold' : 'normal' }}>{revenue > 0 ? fMan(revenue) : '-'}</td>
                            <td style={{ padding: '8px 4px', textAlign: 'right', fontSize: '12px', color: '#e74c3c', fontWeight: expense > 0 ? 'bold' : 'normal' }}>{expense > 0 ? fMan(expense) : '-'}</td>
                            <td style={{ padding: '8px 4px', textAlign: 'right', fontSize: '12px', fontWeight: 'bold', color: netProfit > 0 ? '#27ae60' : netProfit < 0 ? '#e74c3c' : '#95a5a6' }}>
                              {netProfit !== 0 ? fMan(netProfit) : '-'}
                            </td>
                          </tr>
                        );
                      })}
                      <tr style={{ background: '#f8f9fa', borderTop: '2px solid #ecf0f1', fontWeight: 'bold' }}>
                        <td style={{ padding: '10px 4px', fontSize: '12px', color: '#2c3e50' }}>í•©ê³„</td>
                        <td style={{ padding: '10px 4px', textAlign: 'right', fontSize: '13px', color: '#27ae60' }}>
                          {fMan(payments.filter(p => p.year_month?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, p) => s + (p.amount || 0), 0))}
                        </td>
                        <td style={{ padding: '10px 4px', textAlign: 'right', fontSize: '13px', color: '#e74c3c' }}>
                          {fMan(expenses.filter(e => e.date?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, e) => s + (e.amount || 0), 0))}
                        </td>
                        <td style={{ padding: '10px 4px', textAlign: 'right', fontSize: '13px', color: payments.filter(p => p.year_month?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, p) => s + (p.amount || 0), 0) - expenses.filter(e => e.date?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, e) => s + (e.amount || 0), 0) >= 0 ? '#27ae60' : '#e74c3c' }}>
                          {fMan(payments.filter(p => p.year_month?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, p) => s + (p.amount || 0), 0) - expenses.filter(e => e.date?.startsWith(new Date(selectedMonth).getFullYear().toString())).reduce((s, e) => s + (e.amount || 0), 0))}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}

          {/* ëŒ€ì¶œ íƒ­ - ê°„ëµí™” */}
          {!loading && activeTab === 'loans' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                <h2 style={{ fontSize: '22px', color: '#2c3e50', fontWeight: 'bold' }}>ğŸ¦ ëŒ€ì¶œ</h2>
                <button className="btn" onClick={() => openModal('loan')} style={{ padding: '9px 16px', background: '#c0392b', color: 'white' }}>+ ì¶”ê°€</button>
              </div>
              <div className="stat-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(3,1fr)', gap: '8px', marginBottom: '12px' }}>
                {[{ label: 'ì´ ì”ì•¡', val: fUk(totalLoan), color: '#c0392b' }, { label: 'ì›” ì´ì', val: fMan(totalMInt), color: '#e67e22' }, { label: 'ì—° ì´ì', val: fMan(totalMInt * 12), color: '#f39c12' }].map(({ label, val, color }) => (
                  <div key={label} className="card stat-card" style={{ padding: '14px', borderLeft: `4px solid ${color}` }}>
                    <div className="stat-card-label" style={{ fontSize: '10px', color: '#7f8c8d', marginBottom: '4px' }}>{label}</div>
                    <div className="stat-card-value" style={{ fontSize: '16px', fontWeight: 'bold', color }}>{val}</div>
                  </div>
                ))}
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit,minmax(280px,1fr))', gap: '10px' }}>
                {loans.map(loan => {
                  const payments = loanPayments.filter(p => p.loan_id === loan.id);
                  const totalPaid = payments.reduce((s, p) => s + (p.amount || 0), 0);
                  const currentBalance = (loan.initial_amount || loan.remaining_amount || 0) - totalPaid;
                  const yi = currentBalance * (loan.final_rate || 0);
                  return (
                    <div key={loan.id} className="card" style={{ overflow: 'hidden', cursor: 'pointer' }} onClick={() => setDetailLoan(loan)}>
                      <div style={{ background: '#2c3e50', color: 'white', padding: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ flex: 1, minWidth: 0, fontSize: '15px', fontWeight: 'bold', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>ğŸ¦ {loan.lender_name}</div>
                        <button className="btn" onClick={(e) => { e.stopPropagation(); deleteItem('loans', loan.id); }} style={{ padding: '5px 8px', background: '#e74c3c', color: 'white', flexShrink: 0, marginLeft: '6px' }}>ì‚­ì œ</button>
                      </div>
                      <div style={{ padding: '14px' }}>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '10px' }}>
                          <div><div style={{ fontSize: '10px', color: '#7f8c8d', marginBottom: '2px' }}>í˜„ì¬ ì”ì•¡</div><div style={{ fontSize: '16px', fontWeight: 'bold', color: '#c0392b' }}>{fUk(currentBalance)}</div></div>
                          <div><div style={{ fontSize: '10px', color: '#7f8c8d', marginBottom: '2px' }}>ê¸ˆë¦¬</div><div style={{ fontSize: '16px', fontWeight: 'bold', color: '#2c3e50' }}>{((loan.final_rate || 0) * 100).toFixed(2)}%</div></div>
                        </div>
                        <div style={{ background: '#fef9f0', border: '2px solid #f39c12', borderRadius: '8px', padding: '10px' }}>
                          <div style={{ fontSize: '11px', fontWeight: 'bold', marginBottom: '6px' }}>ğŸ“Š ì´ì ìë™ê³„ì‚°</div>
                          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}><span style={{ fontSize: '11px', color: '#7f8c8d' }}>ì—° ì´ì</span><strong style={{ color: '#e67e22', fontSize: '12px' }}>{fNum(yi)}ì›</strong></div>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ fontSize: '11px', color: '#7f8c8d' }}>ì›” ì´ì</span><strong style={{ color: '#e74c3c', fontSize: '14px' }}>{fNum(yi / 12)}ì›</strong></div>
                        </div>
                        {totalPaid > 0 && (
                          <div style={{ marginTop: '8px', fontSize: '11px', color: '#27ae60', textAlign: 'center', background: '#e8f8f5', padding: '5px', borderRadius: '6px' }}>
                            ì´ {fNum(totalPaid)}ì› ìƒí™˜ ({payments.length}ê±´)
                          </div>
                        )}
                        <div style={{ marginTop: '8px', textAlign: 'center', fontSize: '11px', color: '#3498db', fontWeight: 'bold' }}>
                          í´ë¦­í•˜ì—¬ ìƒì„¸ ê´€ë¦¬ â†’
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* ê´€ë¦¬ì íƒ­ - ê°„ëµí™” */}
          {!loading && activeTab === 'admins' && (
            <div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                <h2 style={{ fontSize: '22px', color: '#2c3e50', fontWeight: 'bold' }}>âš™ï¸ ê´€ë¦¬ì</h2>
                <button className="btn" onClick={() => openModal('admin')} style={{ padding: '9px 16px', background: '#8e44ad', color: 'white' }}>+ ì¶”ê°€</button>
              </div>
              <div className="card" style={{ padding: '12px' }}>
                {admins.map((a, i) => (
                  <div key={a.id} style={{ padding: '10px 0', borderBottom: i < admins.length - 1 ? '1px solid #f5f5f5' : 'none', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ fontSize: '14px', fontWeight: 'bold', color: '#2c3e50', marginBottom: '2px' }}>ğŸ‘¤ {a.name}</div>
                      <div style={{ display: 'flex', gap: '4px', marginTop: '3px' }}>
                        <span style={{ background: a.role === 'super' ? '#e74c3c' : '#3498db', color: 'white', padding: '2px 6px', borderRadius: '8px', fontSize: '10px', fontWeight: 'bold' }}>{a.role === 'super' ? 'ìµœê³ ê´€ë¦¬ì' : 'ê´€ë¦¬ì'}</span>
                        <span style={{ background: a.active ? '#27ae60' : '#95a5a6', color: 'white', padding: '2px 6px', borderRadius: '8px', fontSize: '10px', fontWeight: 'bold' }}>{a.active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span>
                      </div>
                    </div>
                    {a.id !== admin.id && <button className="btn" onClick={() => deleteItem('admins', a.id)} style={{ padding: '5px 8px', background: '#e74c3c', color: 'white', flexShrink: 0 }}>ì‚­ì œ</button>}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ */}
        <div id="mob-nav">
          {tabs.map(({ id, icon, label }) => (
            <button key={id} className={`mob-btn${activeTab === id ? ' active' : ''}`} onClick={() => setActiveTab(id)}>
              <span>{icon}</span><span>{label}</span>
            </button>
          ))}
        </div>

        {/* ìˆ˜ë‚© ëª¨ë‹¬ */}
        {payTenant && <PaymentModal tenant={payTenant} payments={payments} onClose={() => setPayTenant(null)} onRefresh={loadPayments} />}

        {/* ëŒ€ì¶œ ìƒì„¸ ëª¨ë‹¬ */}
        {detailLoan && <LoanDetailModal loan={detailLoan} loanPayments={loanPayments} onClose={() => setDetailLoan(null)} onRefresh={loadData} />}

        {/* ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ - ê°„ëµí™” */}
        {showModal && (
          <div className="modal-wrap" onClick={e => { if (e.target === e.currentTarget) setShowModal(false); }}
            style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '14px' }}>
            <div className="modal-inner card" onClick={e => e.stopPropagation()}
              style={{ width: '100%', maxWidth: '460px', maxHeight: '85vh', overflowY: 'auto', padding: '20px', position: 'relative' }}>
              <button onClick={() => setShowModal(false)} style={{ position: 'absolute', top: '12px', right: '12px', background: '#e74c3c', color: 'white', border: 'none', borderRadius: '50%', width: '28px', height: '28px', fontSize: '16px', cursor: 'pointer', fontWeight: 'bold' }}>Ã—</button>
              <h3 style={{ fontSize: '17px', color: '#2c3e50', marginBottom: '16px' }}>{editItem ? 'ìˆ˜ì •' : 'ë“±ë¡'} - {{ tenant: 'ì„ì°¨ì¸', expense: 'ì§€ì¶œ', loan: 'ëŒ€ì¶œ', admin: 'ê´€ë¦¬ì' }[modalType]}</h3>
              <form onSubmit={saveData}>
                {modalType === 'tenant' && <>
                  {[{ l: 'í˜¸ìˆ˜', f: 'room', t: 'text' }, { l: 'ì´ë¦„', f: 'name', t: 'text' }, { l: 'ì—°ë½ì²˜', f: 'contact', t: 'text' }, { l: 'ë³´ì¦ê¸ˆ', f: 'deposit', t: 'number' }, { l: 'ì›”ì„¸', f: 'monthly_rent', t: 'number' }, { l: 'ê´€ë¦¬ë¹„', f: 'maintenance_fee', t: 'number' }, { l: 'ë‚©ì…ì¼', f: 'payment_day', t: 'number' }, { l: 'ì…ì£¼ì¼', f: 'move_in_date', t: 'date' }, { l: 'ë§Œë£Œì¼', f: 'contract_end', t: 'date' }].map(({ l, f, t }) => (
                    <div key={f}><label style={lbl}>{l}</label><input type={t} value={formData[f] || ''} onChange={e => setFormData({ ...formData, [f]: t === 'number' ? (parseInt(e.target.value) || 0) : e.target.value })} style={inp} required /></div>
                  ))}
                </>}
                {modalType === 'expense' && <>
                  <label style={lbl}>ë‚ ì§œ</label><input type="date" value={formData.date || ''} onChange={e => setFormData({ ...formData, date: e.target.value })} style={inp} required />
                  <label style={lbl}>ì¹´í…Œê³ ë¦¬</label>
                  <select value={formData.category_name || ''} onChange={e => setFormData({ ...formData, category_name: e.target.value })} style={inp} required>
                    <option value="">ì„ íƒ</option>
                    {expenseCategories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                  </select>
                  <label style={lbl}>ê¸ˆì•¡</label><input type="number" value={formData.amount || ''} onChange={e => setFormData({ ...formData, amount: parseInt(e.target.value) || 0 })} style={inp} required />
                  <label style={lbl}>ì„¤ëª…</label><input value={formData.description || ''} onChange={e => setFormData({ ...formData, description: e.target.value })} style={inp} />
                </>}
                {modalType === 'loan' && <>
                  <label style={lbl}>ëŒ€ì¶œì²˜</label><input value={formData.lender_name || ''} onChange={e => setFormData({ ...formData, lender_name: e.target.value })} style={inp} required />
                  <label style={lbl}>ëŒ€ì¶œì”ì•¡</label><input type="number" value={formData.remaining_amount || ''} onChange={e => setFormData({ ...formData, remaining_amount: parseInt(e.target.value) || 0 })} style={inp} required />
                  <label style={lbl}>ê¸ˆë¦¬ (%)</label><input type="number" step="0.01" value={formData.final_rate ? (formData.final_rate * 100).toFixed(2) : ''} onChange={e => setFormData({ ...formData, final_rate: parseFloat(e.target.value) / 100 || 0 })} style={inp} required />
                </>}
                {modalType === 'admin' && <>
                  <label style={lbl}>ì´ë¦„</label><input value={formData.name || ''} onChange={e => setFormData({ ...formData, name: e.target.value })} style={inp} required />
                  <label style={lbl}>ë¹„ë°€ë²ˆí˜¸</label><input type="number" value={formData.passcode || ''} onChange={e => setFormData({ ...formData, passcode: e.target.value })} style={inp} required />
                  <label style={lbl}>ê¶Œí•œ</label>
                  <select value={formData.role || 'admin'} onChange={e => setFormData({ ...formData, role: e.target.value })} style={inp}>
                    <option value="super">ìµœê³ ê´€ë¦¬ì</option><option value="admin">ê´€ë¦¬ì</option>
                  </select>
                </>}
                <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                  <button type="button" className="btn" onClick={() => setShowModal(false)} style={{ flex: 1, padding: '11px', background: '#95a5a6', color: 'white' }}>ì·¨ì†Œ</button>
                  <button type="submit" className="btn" style={{ flex: 1, padding: '11px', background: '#27ae60', color: 'white' }}>{editItem ? 'ìˆ˜ì •' : 'ë“±ë¡'}</button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    </>
  );

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>
</html>
